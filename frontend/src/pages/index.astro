---
import Layout from '../layouts/Layout.astro';

type Publication = {
	id: string;
	state: string;
	title: string;
	summary: string;
	body: string;
	category?: string | null;
	tags: string[];
	created_at: string;
	published_at?: string | null;
};

const API_BASE = import.meta.env.PUBLIC_API_BASE_URL ?? 'http://localhost:8000';
let pubs: Publication[] = [];
let error = false;

try {
	const res = await fetch(`${API_BASE}/api/publications`);
	if (res.ok) {
		pubs = await res.json();
	} else {
		error = true;
	}
} catch (e) {
	error = true;
}
---

<Layout>
	<section class="hero">
		<div class="hero-content">
			<span class="hero-badge">Procesado por IA</span>
			<h1 class="hero-title">La data justa</h1>
			<p class="hero-subtitle">Noticias resumidas, reescritas y optimizadas para lectura rapida. Sin relleno, sin vueltas.</p>
			<div class="hero-stats">
				<div class="stat">
					<span class="stat-value">{pubs.length}</span>
					<span class="stat-label">Noticias</span>
				</div>
				<div class="stat">
					<span class="stat-value">24/7</span>
					<span class="stat-label">Actualizacion</span>
				</div>
				<div class="stat">
					<span class="stat-value">IA</span>
					<span class="stat-label">Procesamiento</span>
				</div>
			</div>
		</div>
	</section>

	<section class="news-section">
		<div class="section-header">
			<h2 class="section-title">Ultimas noticias</h2>
			<span class="section-badge">{pubs.length} publicaciones</span>
		</div>

		{error ? (
			<div class="error-card">
				<p>No se pudo conectar con el servidor.</p>
			</div>
		) : pubs.length === 0 ? (
			<div class="empty-card">
				<p>Todavia no hay publicaciones.</p>
				<span class="empty-hint">Usa la API para hacer scraping.</span>
			</div>
		) : (
			<div class="news-grid">
				{pubs.map((p) => (
					<article class="news-card" data-id={p.id}>
						<div class="card-header">
							{p.category && <span class="card-category">{p.category}</span>}
						</div>
						<a class="card-title" href={`/p/${p.id}`}>{p.title}</a>
						<p class="card-summary">{p.summary}</p>
						<div class="card-footer">
							<div class="card-tags">
								{(p.tags ?? []).slice(0, 3).map((t) => (
									<span class="tag">{t}</span>
								))}
							</div>
							<div class="card-votes">
								<button class="vote-btn hot" data-type="hot">Alta Data</button>
								<button class="vote-btn cold" data-type="cold">Fria</button>
								<span class="vote-counts"></span>
							</div>
						</div>
					</article>
				))}
			</div>
		)}
	</section>
</Layout>

<script>
	const API_BASE = import.meta.env.PUBLIC_API_BASE_URL ?? 'http://localhost:8000';
	document.querySelectorAll('article.news-card').forEach((card) => {
		const id = card.getAttribute('data-id');
		if (!id) return;
		const countsEl = card.querySelector('.vote-counts');
		card.querySelectorAll('button.vote-btn').forEach((btn) => {
			btn.addEventListener('click', async (e) => {
				e.preventDefault();
				const voteType = btn.getAttribute('data-type');
				if (!voteType) return;
				try {
					const r = await fetch(`${API_BASE}/api/publications/${id}/vote`, {
						method: 'POST',
						headers: { 'content-type': 'application/json' },
						body: JSON.stringify({ vote_type: voteType }),
					});
					if (!r.ok) throw new Error(String(r.status));
					const data = await r.json();
					if (countsEl) countsEl.textContent = `Alta ${data.hot} - Fria ${data.cold}`;
				} catch (e) {
					if (countsEl) countsEl.textContent = 'Error';
				}
			});
		});
	});
</script>

<style>
	.hero { padding: 48px 0; border-bottom: 1px solid var(--border-subtle); margin-bottom: 32px; }
	.hero-content { max-width: 700px; }
	.hero-badge { display: inline-block; padding: 6px 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid var(--border-medium); border-radius: var(--radius-lg); color: var(--accent-secondary); font-size: 0.85rem; font-weight: 500; margin-bottom: 16px; }
	.hero-title { margin: 0 0 16px; font-size: 3rem; font-weight: 800; letter-spacing: -1px; background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
	.hero-subtitle { margin: 0 0 32px; font-size: 1.15rem; color: var(--text-secondary); line-height: 1.6; }
	.hero-stats { display: flex; gap: 32px; }
	.stat { display: flex; flex-direction: column; gap: 4px; }
	.stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent-primary); }
	.stat-label { font-size: 0.85rem; color: var(--text-muted); }
	.news-section { margin-bottom: 48px; }
	.section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
	.section-title { margin: 0; font-size: 1.5rem; font-weight: 700; }
	.section-badge { padding: 4px 10px; background: var(--bg-card); border-radius: var(--radius-sm); font-size: 0.8rem; color: var(--text-muted); }
	.error-card, .empty-card { padding: 48px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); text-align: center; }
	.error-card p, .empty-card p { margin: 0 0 8px; color: var(--text-secondary); }
	.empty-hint { font-size: 0.9rem; color: var(--text-muted); }
	.news-grid { display: grid; gap: 20px; }
	.news-card { padding: 24px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); transition: all 0.2s ease; }
	.news-card:hover { background: var(--bg-card-hover); border-color: var(--border-medium); transform: translateY(-2px); }
	.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
	.card-category { padding: 4px 10px; background: rgba(59, 130, 246, 0.15); border-radius: var(--radius-sm); font-size: 0.8rem; color: var(--accent-secondary); font-weight: 500; }
	.card-title { display: block; font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin-bottom: 10px; line-height: 1.35; }
	.card-title:hover { color: var(--accent-secondary); }
	.card-summary { margin: 0 0 16px; color: var(--text-secondary); line-height: 1.5; }
	.card-footer { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
	.card-tags { display: flex; gap: 8px; flex-wrap: wrap; }
	.tag { padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); font-size: 0.8rem; color: var(--text-muted); }
	.card-votes { display: flex; align-items: center; gap: 8px; }
	.vote-btn { display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-secondary); cursor: pointer; transition: all 0.2s; font-size: 0.85rem; }
	.vote-btn:hover { background: var(--bg-card-hover); border-color: var(--border-medium); }
	.vote-btn.hot:hover { border-color: #f59e0b; color: #f59e0b; }
	.vote-btn.cold:hover { border-color: #3b82f6; color: #3b82f6; }
	.vote-counts { font-size: 0.85rem; color: var(--text-muted); }
	@media (max-width: 768px) { .hero-title { font-size: 2rem; } .hero-stats { gap: 24px; } .card-footer { flex-direction: column; align-items: flex-start; } }
</style>
