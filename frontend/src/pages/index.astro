---
import Layout from '../layouts/Layout.astro';
import Skeleton from '../components/Skeleton.astro';

interface Agent {
	id: string;
	name: string;
	slug: string;
	description: string;
	specialization?: string | null;
	avatar_url?: string | null;
}

interface Publication {
	id: string;
	state: string;
	title: string;
	summary: string;
	body: string;
	category?: string | null;
	tags: string[];
	created_at: string;
	published_at?: string | null;
	agent?: Agent | null;
}

interface PaginatedResponse {
	items: Publication[];
	total: number;
	limit: number;
	offset: number;
	has_more: boolean;
}

const API_BASE = import.meta.env.PUBLIC_API_BASE_URL ?? 'http://localhost:8000';
const SITE_URL = import.meta.env.SITE ?? 'http://localhost:4321';

let pubs: Publication[] = [];
let total = 0;
let hasMore = false;
let error = false;

try {
	const res = await fetch(`${API_BASE}/api/publications/search?limit=30`);
	if (res.ok) {
		const data: PaginatedResponse = await res.json();
		pubs = data.items;
		total = data.total;
		hasMore = data.has_more;
	} else {
		error = true;
	}
} catch (e) {
	error = true;
}

// Separar noticias destacadas (hasta 3)
const featuredPubs = pubs.slice(0, 2); // Por ahora 2, puede ser 1-3
const remainingPubs = pubs.slice(featuredPubs.length);
---

<Layout>
	{error ? (
		<div class="error-card">
			<p>No se pudo conectar con el servidor.</p>
		</div>
	) : pubs.length === 0 ? (
		<div class="empty-card">
			<p>Todavia no hay publicaciones.</p>
			<span class="empty-hint">Usa la API para hacer scraping.</span>
		</div>
	) : (
		<>
			{/* Secci√≥n de noticias destacadas */}
			{featuredPubs.length > 0 && (
				<section class="featured-section">
					<div class="featured-grid">
						{featuredPubs.map((pub, index) => (
							<article class={`featured-card ${index === 0 ? 'featured-main' : 'featured-secondary'}`} data-id={pub.id}>
								<div class="featured-content">
									{pub.category && <span class="featured-category">{pub.category}</span>}
									<a class="featured-title" href={`/p/${pub.id}`}>{pub.title}</a>
									<p class="featured-summary">{pub.summary}</p>
								</div>
							</article>
						))}
					</div>
				</section>
			)}

			{/* Grid de noticias en 3 columnas */}
			<section class="news-section">
				<div class="section-header">
					<h2 class="section-title">Ultimas noticias</h2>
					<span class="section-badge" id="pub-count">{total} publicaciones</span>
				</div>

				<div class="news-grid" id="news-grid">
					{remainingPubs.map((p) => (
						<article class="news-card" data-id={p.id}>
							{p.category && <span class="card-category">{p.category}</span>}
							<a class="card-title" href={`/p/${p.id}`}>{p.title}</a>
							<p class="card-summary">{p.summary}</p>
							<div class="card-footer">
								<div class="card-tags">
									{(p.tags ?? []).slice(0, 2).map((t) => (
										<span class="tag">{t}</span>
									))}
								</div>
								<div class="card-votes">
									<button class="vote-btn hot" data-type="hot">üî•</button>
									<button class="vote-btn cold" data-type="cold">‚ùÑÔ∏è</button>
									<span class="vote-counts"></span>
								</div>
							</div>
						</article>
					))}
				</div>
			</section>
		</>
	)}

		{hasMore && (
			<div id="load-more-container">
				<div id="loading-indicator" style="display: none;">
					<Skeleton count={2} />
				</div>
				<div id="scroll-trigger"></div>
			</div>
		)}
	</section>
</Layout>

<script>
	// Use client-specific API URL for browser requests
	const API_BASE = import.meta.env.PUBLIC_CLIENT_API_BASE_URL ?? import.meta.env.PUBLIC_API_BASE_URL ?? 'http://localhost:8000';
	const SITE_URL = import.meta.env.SITE ?? 'http://localhost:4321';

	console.log('API_BASE configured as:', API_BASE);

	let currentOffset = 30;
	let isLoading = false;
	let hasMore = true;
	let currentFilters: Record<string, string> = {};

	// Voting
	function setupVoting(container: Element) {
		container.querySelectorAll('article.news-card').forEach((card) => {
			const id = card.getAttribute('data-id');
			if (!id) return;
			const countsEl = card.querySelector('.vote-counts');
			card.querySelectorAll('button.vote-btn').forEach((btn) => {
				btn.addEventListener('click', async (e) => {
					e.preventDefault();
					const voteType = btn.getAttribute('data-type');
					if (!voteType) return;
					try {
						const url = `${API_BASE}/api/publications/${id}/vote`;
						console.log('Voting to URL:', url);
						const r = await fetch(url, {
							method: 'POST',
							headers: { 'content-type': 'application/json' },
							body: JSON.stringify({ vote_type: voteType }),
						});
						if (!r.ok) throw new Error(String(r.status));
						const data = await r.json();
						if (countsEl) countsEl.textContent = `Alta ${data.hot} - Fria ${data.cold}`;
					} catch (e) {
						if (countsEl) countsEl.textContent = 'Error';
					}
				});
			});
		});
	}

	// Create news card HTML
	function createCardHTML(p: any): string {
		const tags = (p.tags || []).slice(0, 2).map((t: string) => `<span class="tag">${t}</span>`).join('');
		const category = p.category ? `<span class="card-category">${p.category}</span>` : '';

		return `
			<article class="news-card" data-id="${p.id}">
				${category}
				<a class="card-title" href="/p/${p.id}">${p.title}</a>
				<p class="card-summary">${p.summary}</p>
				<div class="card-footer">
					<div class="card-tags">${tags}</div>
					<div class="card-votes">
						<button class="vote-btn hot" data-type="hot">üî•</button>
						<button class="vote-btn cold" data-type="cold">‚ùÑÔ∏è</button>
						<span class="vote-counts"></span>
					</div>
				</div>
			</article>
		`;
	}

	// Load more publications
	async function loadMore() {
		if (isLoading || !hasMore) return;
		isLoading = true;

		const loadingIndicator = document.getElementById('loading-indicator');
		if (loadingIndicator) loadingIndicator.style.display = 'block';

		try {
			const params = new URLSearchParams({
				limit: '20',
				offset: String(currentOffset),
				...currentFilters,
			});

			const r = await fetch(`${API_BASE}/api/publications/search?${params}`);
			if (!r.ok) throw new Error(String(r.status));

			const data = await r.json();
			const grid = document.getElementById('news-grid');

			if (grid && data.items.length > 0) {
				const fragment = document.createDocumentFragment();
				const tempDiv = document.createElement('div');

				data.items.forEach((p: any) => {
					tempDiv.innerHTML = createCardHTML(p);
					const card = tempDiv.firstElementChild;
					if (card) {
						card.classList.add('fade-in');
						fragment.appendChild(card);
					}
				});

				grid.appendChild(fragment);
				setupVoting(grid);

				currentOffset += data.items.length;
				hasMore = data.has_more;
			} else {
				hasMore = false;
			}

			if (!hasMore) {
				const container = document.getElementById('load-more-container');
				if (container) container.style.display = 'none';
			}
		} catch (e) {
			console.error('Error loading more:', e);
		} finally {
			isLoading = false;
			if (loadingIndicator) loadingIndicator.style.display = 'none';
		}
	}

	// Initialize
	document.addEventListener('DOMContentLoaded', () => {
		const grid = document.getElementById('news-grid');
		if (grid) {
			setupVoting(grid);
		}

		// Infinite scroll
		const scrollTrigger = document.getElementById('scroll-trigger');
		if (scrollTrigger) {
			const observer = new IntersectionObserver(
				(entries) => {
					if (entries[0].isIntersecting) {
						loadMore();
					}
				},
				{ rootMargin: '200px' }
			);
			observer.observe(scrollTrigger);
		}
	});
</script>

<style>
	/* Featured Section - Noticias destacadas */
	.featured-section {
		margin-bottom: 40px;
		padding-bottom: 32px;
		border-bottom: 2px solid var(--border-subtle);
	}

	.featured-grid {
		display: grid;
		gap: 24px;
		grid-template-columns: 1fr;
	}

	/* Grid responsive: 1 columna en mobile, 2 en tablet+, 3 en desktop */
	@media (min-width: 768px) {
		.featured-grid {
			grid-template-columns: repeat(2, 1fr);
		}
	}

	@media (min-width: 1200px) {
		.featured-grid {
			grid-template-columns: repeat(3, 1fr);
		}

		/* Cuando hay 2 items, la primera ocupa 2 columnas */
		.featured-grid:has(.featured-card:nth-child(2):last-child) {
			grid-template-columns: 2fr 1fr;
		}
	}

	.featured-card {
		background: var(--bg-card);
		border: 1px solid var(--border-medium);
		border-radius: var(--radius-lg);
		padding: 28px;
		transition: all 0.3s ease;
	}

	.featured-card:hover {
		border-color: var(--accent-primary);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
	}

	/* La primera noticia es m√°s grande */
	.featured-main .featured-title {
		font-size: 2.5rem;
	}

	.featured-main .featured-summary {
		font-size: 1.2rem;
	}

	/* Noticias secundarias son m√°s compactas */
	.featured-secondary .featured-title {
		font-size: 1.75rem;
	}

	.featured-secondary .featured-summary {
		font-size: 1rem;
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.featured-category {
		display: inline-block;
		padding: 6px 16px;
		background: var(--accent-primary);
		color: white;
		border-radius: var(--radius-sm);
		font-size: 0.85rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		margin-bottom: 16px;
	}

	.featured-title {
		display: block;
		font-size: 2.5rem;
		font-weight: 900;
		line-height: 1.2;
		color: var(--text-primary);
		margin-bottom: 16px;
		letter-spacing: -0.5px;
	}

	.featured-title:hover {
		color: var(--accent-secondary);
	}

	.featured-summary {
		font-size: 1.2rem;
		line-height: 1.6;
		color: var(--text-secondary);
		margin: 0;
	}

	/* News Section */
	.news-section { margin-bottom: 48px; }
	.section-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 12px;
		margin-bottom: 24px;
		padding-bottom: 12px;
		border-bottom: 1px solid var(--border-subtle);
	}
	.section-title {
		margin: 0;
		font-size: 1.75rem;
		font-weight: 800;
		letter-spacing: -0.5px;
	}
	.section-badge {
		padding: 6px 12px;
		background: var(--bg-secondary);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-md);
		font-size: 0.85rem;
		color: var(--text-secondary);
		font-weight: 500;
	}

	.error-card, .empty-card {
		padding: 48px;
		background: var(--bg-card);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-lg);
		text-align: center;
	}
	.error-card p, .empty-card p { margin: 0 0 8px; color: var(--text-secondary); }
	.empty-hint { font-size: 0.9rem; color: var(--text-muted); }

	/* Grid de 3 columnas estilo Infobae */
	.news-grid {
		display: grid;
		gap: 24px;
		grid-template-columns: 1fr;
	}

	@media (min-width: 768px) {
		.news-grid {
			grid-template-columns: repeat(2, 1fr);
		}
	}

	@media (min-width: 1200px) {
		.news-grid {
			grid-template-columns: repeat(3, 1fr);
		}
	}

	/* Cards compactas estilo Infobae */
	.news-card {
		background: var(--bg-card);
		border-bottom: 3px solid var(--border-subtle);
		padding: 0 0 20px 0;
		transition: all 0.2s ease;
	}

	.news-card:hover {
		border-bottom-color: var(--accent-primary);
	}

	.card-category {
		display: inline-block;
		padding: 4px 12px;
		background: rgba(59, 130, 246, 0.1);
		border-left: 3px solid var(--accent-secondary);
		font-size: 0.75rem;
		color: var(--accent-secondary);
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		margin-bottom: 12px;
	}

	.card-title {
		display: block;
		font-size: 1.15rem;
		font-weight: 700;
		color: var(--text-primary);
		margin-bottom: 10px;
		line-height: 1.4;
		transition: color 0.2s;
	}

	.card-title:hover {
		color: var(--accent-secondary);
	}

	.card-summary {
		margin: 0 0 16px;
		color: var(--text-secondary);
		line-height: 1.6;
		font-size: 0.95rem;
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.card-footer {
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: 12px;
		padding-top: 12px;
		border-top: 1px solid var(--border-subtle);
	}

	.card-tags {
		display: flex;
		gap: 6px;
		flex-wrap: wrap;
		flex: 1;
	}

	.tag {
		padding: 4px 8px;
		background: var(--bg-secondary);
		border-radius: var(--radius-sm);
		font-size: 0.75rem;
		color: var(--text-muted);
		white-space: nowrap;
	}

	.card-votes {
		display: flex;
		align-items: center;
		gap: 6px;
		flex-shrink: 0;
	}

	.vote-btn {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 32px;
		height: 32px;
		background: var(--bg-secondary);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-md);
		cursor: pointer;
		transition: all 0.2s;
		font-size: 1rem;
	}

	.vote-btn:hover {
		background: var(--bg-card-hover);
		border-color: var(--border-medium);
		transform: scale(1.1);
	}

	.vote-btn.hot:hover {
		border-color: #f59e0b;
		background: rgba(245, 158, 11, 0.1);
	}

	.vote-btn.cold:hover {
		border-color: #3b82f6;
		background: rgba(59, 130, 246, 0.1);
	}

	.vote-counts {
		font-size: 0.8rem;
		color: var(--text-muted);
		white-space: nowrap;
	}

	/* Fade in animation */
	:global(.fade-in) {
		animation: fadeIn 0.3s ease-out;
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	#scroll-trigger {
		height: 1px;
	}

	@media (max-width: 768px) {
		.featured-section {
			margin-bottom: 28px;
			padding-bottom: 24px;
		}

		.featured-main .featured-title,
		.featured-secondary .featured-title {
			font-size: 1.5rem;
		}

		.featured-main .featured-summary,
		.featured-secondary .featured-summary {
			font-size: 0.95rem;
		}

		.featured-card {
			padding: 16px;
		}

		.featured-category {
			padding: 4px 12px;
			font-size: 0.75rem;
			margin-bottom: 12px;
		}

		.section-header {
			flex-direction: column;
			align-items: flex-start;
			gap: 8px;
		}

		.section-title {
			font-size: 1.4rem;
		}

		.news-grid {
			gap: 16px;
		}

		.card-title {
			font-size: 1.05rem;
		}

		.card-summary {
			font-size: 0.9rem;
			-webkit-line-clamp: 2;
		}

		.card-footer {
			flex-direction: column;
			align-items: flex-start;
			gap: 10px;
		}

		.card-votes {
			width: 100%;
			justify-content: flex-start;
		}

		.vote-btn {
			width: 36px;
			height: 36px;
		}
	}

	@media (max-width: 480px) {
		.featured-main .featured-title,
		.featured-secondary .featured-title {
			font-size: 1.3rem;
		}

		.featured-card {
			padding: 14px;
		}

		.section-title {
			font-size: 1.25rem;
		}

		.card-category {
			font-size: 0.7rem;
			padding: 3px 10px;
		}

		.tag {
			font-size: 0.7rem;
			padding: 3px 6px;
		}
	}
</style>
