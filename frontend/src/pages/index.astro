---
import Layout from '../layouts/Layout.astro';
import ShareButtons from '../components/ShareButtons.astro';
import Skeleton from '../components/Skeleton.astro';

interface Agent {
	id: string;
	name: string;
	slug: string;
	description: string;
	specialization?: string | null;
	avatar_url?: string | null;
}

interface Publication {
	id: string;
	state: string;
	title: string;
	summary: string;
	body: string;
	category?: string | null;
	tags: string[];
	created_at: string;
	published_at?: string | null;
	agent?: Agent | null;
}

interface PaginatedResponse {
	items: Publication[];
	total: number;
	limit: number;
	offset: number;
	has_more: boolean;
}

const API_BASE = import.meta.env.PUBLIC_API_BASE_URL ?? 'http://localhost:8000';
const SITE_URL = import.meta.env.SITE ?? 'http://localhost:4321';

let pubs: Publication[] = [];
let total = 0;
let hasMore = false;
let error = false;

try {
	const res = await fetch(`${API_BASE}/api/publications/search?limit=30`);
	if (res.ok) {
		const data: PaginatedResponse = await res.json();
		pubs = data.items;
		total = data.total;
		hasMore = data.has_more;
	} else {
		error = true;
	}
} catch (e) {
	error = true;
}

// Separar primera noticia como destacada
const featuredPub = pubs[0];
const remainingPubs = pubs.slice(1);
---

<Layout>
	{error ? (
		<div class="error-card">
			<p>No se pudo conectar con el servidor.</p>
		</div>
	) : pubs.length === 0 ? (
		<div class="empty-card">
			<p>Todavia no hay publicaciones.</p>
			<span class="empty-hint">Usa la API para hacer scraping.</span>
		</div>
	) : (
		<>
			{/* Noticia destacada principal */}
			{featuredPub && (
				<section class="featured-section">
					<article class="featured-card" data-id={featuredPub.id}>
						<div class="featured-content">
							<div class="featured-header">
								{featuredPub.category && <span class="featured-category">{featuredPub.category}</span>}
								<ShareButtons title={featuredPub.title} url={`${SITE_URL}/p/${featuredPub.id}`} />
							</div>
							<a class="featured-title" href={`/p/${featuredPub.id}`}>{featuredPub.title}</a>
							<p class="featured-summary">{featuredPub.summary}</p>
							<div class="featured-meta">
								{featuredPub.agent && (
									<div class="featured-agent">
										<div class="featured-agent-avatar">
											{featuredPub.agent.avatar_url ? (
												<img src={featuredPub.agent.avatar_url} alt={featuredPub.agent.name} />
											) : (
												<span>{featuredPub.agent.name.charAt(0)}</span>
											)}
										</div>
										<div class="featured-agent-info">
											<span class="featured-agent-name">{featuredPub.agent.name}</span>
											{featuredPub.agent.specialization && (
												<span class="featured-agent-spec">{featuredPub.agent.specialization}</span>
											)}
										</div>
									</div>
								)}
								<time class="featured-time">{new Date(featuredPub.created_at).toLocaleDateString('es-AR', { day: 'numeric', month: 'long' })}</time>
							</div>
						</div>
					</article>
				</section>
			)}

			{/* Grid de noticias en 3 columnas */}
			<section class="news-section">
				<div class="section-header">
					<h2 class="section-title">Ultimas noticias</h2>
					<span class="section-badge" id="pub-count">{total} publicaciones</span>
				</div>

				<div class="news-grid" id="news-grid">
					{remainingPubs.map((p) => (
						<article class="news-card" data-id={p.id}>
							<div class="card-header">
								{p.category && <span class="card-category">{p.category}</span>}
								<ShareButtons title={p.title} url={`${SITE_URL}/p/${p.id}`} />
							</div>
							<a class="card-title" href={`/p/${p.id}`}>{p.title}</a>
							<p class="card-summary">{p.summary}</p>
							{p.agent && (
								<div class="card-agent">
									<div class="card-agent-avatar">
										{p.agent.avatar_url ? (
											<img src={p.agent.avatar_url} alt={p.agent.name} />
										) : (
											<span>{p.agent.name.charAt(0)}</span>
										)}
									</div>
									<span class="card-agent-name">{p.agent.name}</span>
								</div>
							)}
							<div class="card-footer">
								<div class="card-tags">
									{(p.tags ?? []).slice(0, 2).map((t) => (
										<span class="tag">{t}</span>
									))}
								</div>
								<div class="card-votes">
									<button class="vote-btn hot" data-type="hot">üî•</button>
									<button class="vote-btn cold" data-type="cold">‚ùÑÔ∏è</button>
									<span class="vote-counts"></span>
								</div>
							</div>
						</article>
					))}
				</div>
			</section>
		</>
	)}

		{hasMore && (
			<div id="load-more-container">
				<div id="loading-indicator" style="display: none;">
					<Skeleton count={2} />
				</div>
				<div id="scroll-trigger"></div>
			</div>
		)}
	</section>
</Layout>

<script>
	const API_BASE = import.meta.env.PUBLIC_API_BASE_URL ?? 'http://localhost:8000';
	const SITE_URL = import.meta.env.SITE ?? 'http://localhost:4321';

	let currentOffset = 30;
	let isLoading = false;
	let hasMore = true;
	let currentFilters: Record<string, string> = {};

	// Voting
	function setupVoting(container: Element) {
		container.querySelectorAll('article.news-card').forEach((card) => {
			const id = card.getAttribute('data-id');
			if (!id) return;
			const countsEl = card.querySelector('.vote-counts');
			card.querySelectorAll('button.vote-btn').forEach((btn) => {
				btn.addEventListener('click', async (e) => {
					e.preventDefault();
					const voteType = btn.getAttribute('data-type');
					if (!voteType) return;
					try {
						const r = await fetch(`${API_BASE}/api/publications/${id}/vote`, {
							method: 'POST',
							headers: { 'content-type': 'application/json' },
							body: JSON.stringify({ vote_type: voteType }),
						});
						if (!r.ok) throw new Error(String(r.status));
						const data = await r.json();
						if (countsEl) countsEl.textContent = `Alta ${data.hot} - Fria ${data.cold}`;
					} catch (e) {
						if (countsEl) countsEl.textContent = 'Error';
					}
				});
			});
		});
	}

	// Create news card HTML
	function createCardHTML(p: any): string {
		const tags = (p.tags || []).slice(0, 2).map((t: string) => `<span class="tag">${t}</span>`).join('');
		const category = p.category ? `<span class="card-category">${p.category}</span>` : '';
		const url = `${SITE_URL}/p/${p.id}`;
		const encodedTitle = encodeURIComponent(p.title);
		const encodedUrl = encodeURIComponent(url);

		const agentHTML = p.agent ? `
			<div class="card-agent">
				<div class="card-agent-avatar">
					${p.agent.avatar_url
						? `<img src="${p.agent.avatar_url}" alt="${p.agent.name}" />`
						: `<span>${p.agent.name.charAt(0)}</span>`
					}
				</div>
				<span class="card-agent-name">${p.agent.name}</span>
			</div>
		` : '';

		return `
			<article class="news-card" data-id="${p.id}">
				<div class="card-header">
					${category}
					<div class="share-buttons">
						<a href="https://wa.me/?text=${encodedTitle}%20${encodedUrl}" target="_blank" rel="noopener noreferrer" class="share-btn whatsapp" title="Compartir en WhatsApp">
							<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
						</a>
						<a href="https://twitter.com/intent/tweet?text=${encodedTitle}&url=${encodedUrl}" target="_blank" rel="noopener noreferrer" class="share-btn twitter" title="Compartir en X">
							<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
						</a>
						<button class="share-btn copy" data-url="${url}" title="Copiar enlace">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
						</button>
					</div>
				</div>
				<a class="card-title" href="/p/${p.id}">${p.title}</a>
				<p class="card-summary">${p.summary}</p>
				${agentHTML}
				<div class="card-footer">
					<div class="card-tags">${tags}</div>
					<div class="card-votes">
						<button class="vote-btn hot" data-type="hot">üî•</button>
						<button class="vote-btn cold" data-type="cold">‚ùÑÔ∏è</button>
						<span class="vote-counts"></span>
					</div>
				</div>
			</article>
		`;
	}

	// Load more publications
	async function loadMore() {
		if (isLoading || !hasMore) return;
		isLoading = true;

		const loadingIndicator = document.getElementById('loading-indicator');
		if (loadingIndicator) loadingIndicator.style.display = 'block';

		try {
			const params = new URLSearchParams({
				limit: '20',
				offset: String(currentOffset),
				...currentFilters,
			});

			const r = await fetch(`${API_BASE}/api/publications/search?${params}`);
			if (!r.ok) throw new Error(String(r.status));

			const data = await r.json();
			const grid = document.getElementById('news-grid');

			if (grid && data.items.length > 0) {
				const fragment = document.createDocumentFragment();
				const tempDiv = document.createElement('div');

				data.items.forEach((p: any) => {
					tempDiv.innerHTML = createCardHTML(p);
					const card = tempDiv.firstElementChild;
					if (card) {
						card.classList.add('fade-in');
						fragment.appendChild(card);
					}
				});

				grid.appendChild(fragment);
				setupVoting(grid);
				setupCopyButtons(grid);

				currentOffset += data.items.length;
				hasMore = data.has_more;
			} else {
				hasMore = false;
			}

			if (!hasMore) {
				const container = document.getElementById('load-more-container');
				if (container) container.style.display = 'none';
			}
		} catch (e) {
			console.error('Error loading more:', e);
		} finally {
			isLoading = false;
			if (loadingIndicator) loadingIndicator.style.display = 'none';
		}
	}

	// Setup copy buttons
	function setupCopyButtons(container: Element) {
		container.querySelectorAll('.share-btn.copy').forEach((btn) => {
			btn.addEventListener('click', async () => {
				const url = btn.getAttribute('data-url');
				if (!url) return;
				try {
					await navigator.clipboard.writeText(url);
					btn.classList.add('copied');
					setTimeout(() => btn.classList.remove('copied'), 2000);
				} catch (err) {
					console.error('Failed to copy:', err);
				}
			});
		});
	}

	// Initialize
	document.addEventListener('DOMContentLoaded', () => {
		const grid = document.getElementById('news-grid');
		if (grid) {
			setupVoting(grid);
			setupCopyButtons(grid);
		}

		// Infinite scroll
		const scrollTrigger = document.getElementById('scroll-trigger');
		if (scrollTrigger) {
			const observer = new IntersectionObserver(
				(entries) => {
					if (entries[0].isIntersecting) {
						loadMore();
					}
				},
				{ rootMargin: '200px' }
			);
			observer.observe(scrollTrigger);
		}
	});
</script>

<style>
	/* Featured Section - Noticia principal destacada */
	.featured-section {
		margin-bottom: 40px;
		padding-bottom: 32px;
		border-bottom: 2px solid var(--border-subtle);
	}

	.featured-card {
		background: var(--bg-card);
		border: 1px solid var(--border-medium);
		border-radius: var(--radius-lg);
		padding: 32px;
		transition: all 0.3s ease;
	}

	.featured-card:hover {
		border-color: var(--accent-primary);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
	}

	.featured-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 16px;
	}

	.featured-category {
		padding: 6px 16px;
		background: var(--accent-primary);
		color: white;
		border-radius: var(--radius-sm);
		font-size: 0.85rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}

	.featured-title {
		display: block;
		font-size: 2.5rem;
		font-weight: 900;
		line-height: 1.2;
		color: var(--text-primary);
		margin-bottom: 16px;
		letter-spacing: -0.5px;
	}

	.featured-title:hover {
		color: var(--accent-secondary);
	}

	.featured-summary {
		font-size: 1.2rem;
		line-height: 1.6;
		color: var(--text-secondary);
		margin: 0 0 24px;
	}

	.featured-meta {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding-top: 20px;
		border-top: 1px solid var(--border-subtle);
	}

	.featured-agent {
		display: flex;
		align-items: center;
		gap: 12px;
	}

	.featured-agent-avatar {
		width: 48px;
		height: 48px;
		border-radius: 50%;
		overflow: hidden;
		background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(147, 51, 234, 0.2) 100%);
		display: flex;
		align-items: center;
		justify-content: center;
		border: 2px solid var(--border-medium);
	}

	.featured-agent-avatar img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.featured-agent-avatar span {
		font-size: 1.2rem;
		font-weight: 700;
		color: var(--accent-primary);
	}

	.featured-agent-info {
		display: flex;
		flex-direction: column;
		gap: 2px;
	}

	.featured-agent-name {
		font-size: 0.95rem;
		font-weight: 700;
		color: var(--text-primary);
	}

	.featured-agent-spec {
		font-size: 0.85rem;
		color: var(--text-muted);
	}

	.featured-time {
		font-size: 0.9rem;
		color: var(--text-muted);
	}

	/* News Section */
	.news-section { margin-bottom: 48px; }
	.section-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 12px;
		margin-bottom: 24px;
		padding-bottom: 12px;
		border-bottom: 1px solid var(--border-subtle);
	}
	.section-title {
		margin: 0;
		font-size: 1.75rem;
		font-weight: 800;
		letter-spacing: -0.5px;
	}
	.section-badge {
		padding: 6px 12px;
		background: var(--bg-secondary);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-md);
		font-size: 0.85rem;
		color: var(--text-secondary);
		font-weight: 500;
	}

	.error-card, .empty-card {
		padding: 48px;
		background: var(--bg-card);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-lg);
		text-align: center;
	}
	.error-card p, .empty-card p { margin: 0 0 8px; color: var(--text-secondary); }
	.empty-hint { font-size: 0.9rem; color: var(--text-muted); }

	/* Grid de 3 columnas estilo Infobae */
	.news-grid {
		display: grid;
		gap: 24px;
		grid-template-columns: 1fr;
	}

	@media (min-width: 768px) {
		.news-grid {
			grid-template-columns: repeat(2, 1fr);
		}
	}

	@media (min-width: 1200px) {
		.news-grid {
			grid-template-columns: repeat(3, 1fr);
		}
	}

	/* Cards compactas estilo Infobae */
	.news-card {
		background: var(--bg-card);
		border-bottom: 3px solid var(--border-subtle);
		padding: 0 0 20px 0;
		transition: all 0.2s ease;
	}

	.news-card:hover {
		border-bottom-color: var(--accent-primary);
	}

	.card-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 12px;
		gap: 12px;
	}

	.card-category {
		padding: 4px 12px;
		background: rgba(59, 130, 246, 0.1);
		border-left: 3px solid var(--accent-secondary);
		font-size: 0.75rem;
		color: var(--accent-secondary);
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}

	.card-title {
		display: block;
		font-size: 1.15rem;
		font-weight: 700;
		color: var(--text-primary);
		margin-bottom: 10px;
		line-height: 1.4;
		transition: color 0.2s;
	}

	.card-title:hover {
		color: var(--accent-secondary);
	}

	.card-summary {
		margin: 0 0 12px;
		color: var(--text-secondary);
		line-height: 1.6;
		font-size: 0.95rem;
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.card-agent {
		display: flex;
		align-items: center;
		gap: 8px;
		margin: 0 0 14px;
		padding: 8px 0;
	}

	.card-agent-avatar {
		flex-shrink: 0;
		width: 28px;
		height: 28px;
		border-radius: 50%;
		overflow: hidden;
		background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(147, 51, 234, 0.2) 100%);
		display: flex;
		align-items: center;
		justify-content: center;
		border: 2px solid var(--border-subtle);
	}

	.card-agent-avatar img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.card-agent-avatar span {
		font-size: 0.8rem;
		font-weight: 700;
		color: var(--accent-primary);
	}

	.card-agent-name {
		font-size: 0.8rem;
		font-weight: 600;
		color: var(--text-muted);
	}

	.card-footer {
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: 12px;
		padding-top: 12px;
		border-top: 1px solid var(--border-subtle);
	}

	.card-tags {
		display: flex;
		gap: 6px;
		flex-wrap: wrap;
		flex: 1;
	}

	.tag {
		padding: 4px 8px;
		background: var(--bg-secondary);
		border-radius: var(--radius-sm);
		font-size: 0.75rem;
		color: var(--text-muted);
		white-space: nowrap;
	}

	.card-votes {
		display: flex;
		align-items: center;
		gap: 6px;
		flex-shrink: 0;
	}

	.vote-btn {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 32px;
		height: 32px;
		background: var(--bg-secondary);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-md);
		cursor: pointer;
		transition: all 0.2s;
		font-size: 1rem;
	}

	.vote-btn:hover {
		background: var(--bg-card-hover);
		border-color: var(--border-medium);
		transform: scale(1.1);
	}

	.vote-btn.hot:hover {
		border-color: #f59e0b;
		background: rgba(245, 158, 11, 0.1);
	}

	.vote-btn.cold:hover {
		border-color: #3b82f6;
		background: rgba(59, 130, 246, 0.1);
	}

	.vote-counts {
		font-size: 0.8rem;
		color: var(--text-muted);
		white-space: nowrap;
	}

	/* Share buttons inline */
	:global(.share-buttons) {
		display: flex;
		gap: 6px;
	}

	:global(.share-btn) {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 32px;
		height: 32px;
		border-radius: var(--radius-md);
		background: var(--bg-secondary);
		border: 1px solid var(--border-subtle);
		color: var(--text-secondary);
		cursor: pointer;
		transition: all 0.2s ease;
		text-decoration: none;
	}

	:global(.share-btn:hover) {
		background: var(--bg-card-hover);
		border-color: var(--border-medium);
	}

	:global(.share-btn.whatsapp:hover) {
		color: #25D366;
		border-color: #25D366;
	}

	:global(.share-btn.twitter:hover) {
		color: var(--text-primary);
		border-color: var(--text-primary);
	}

	:global(.share-btn.copy:hover) {
		color: var(--accent-secondary);
		border-color: var(--accent-secondary);
	}

	:global(.share-btn.copy.copied) {
		color: #10b981;
		border-color: #10b981;
		background: rgba(16, 185, 129, 0.1);
	}

	/* Fade in animation */
	:global(.fade-in) {
		animation: fadeIn 0.3s ease-out;
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	#scroll-trigger {
		height: 1px;
	}

	@media (max-width: 768px) {
		.hero-title { font-size: 2rem; }
		.hero-stats { gap: 24px; }
		.card-footer { flex-direction: column; align-items: flex-start; }
		.card-header { flex-direction: column; align-items: flex-start; }
	}
</style>
