---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Administrar Secciones">
  <div class="page-header">
    <div>
      <h1>Secciones del Menú</h1>
      <p class="subtitle">Gestiona las secciones de navegación y sus categorías</p>
    </div>
    <button class="btn btn-primary" id="btn-new-section">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
        <path d="M12 5v14m-7-7h14"></path>
      </svg>
      Nueva Sección
    </button>
  </div>

  <div class="card">
    <div class="sections-list" id="sections-list">
      <div class="loading-cell">Cargando secciones...</div>
    </div>
  </div>

  <!-- Modal for create/edit section -->
  <div class="modal" id="section-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Nueva Sección</h2>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="section-form">
          <input type="hidden" id="section-id" />

          <div class="form-group">
            <label for="section-name">Nombre *</label>
            <input type="text" id="section-name" class="form-input" required />
          </div>

          <div class="form-group">
            <label for="section-slug">Slug (URL) *</label>
            <input type="text" id="section-slug" class="form-input" required />
            <small>Ejemplo: politica, medio-ambiente</small>
          </div>

          <div class="form-group">
            <label for="section-description">Descripción</label>
            <textarea id="section-description" class="form-input" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label for="section-icon">Icono</label>
            <input type="text" id="section-icon" class="form-input" placeholder="newspaper, globe, heart..." />
            <small>Nombre del icono (Lucide icons)</small>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="section-order">Orden</label>
              <input type="number" id="section-order" class="form-input" value="0" min="0" />
            </div>

            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="section-active" checked />
                <span>Activa</span>
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="btn-cancel">Cancelar</button>
        <button class="btn btn-primary" id="btn-save">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal for managing categories -->
  <div class="modal" id="categories-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="categories-modal-title">Categorías</h2>
        <button class="modal-close" id="categories-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="categories-section-id" />

        <div class="form-group">
          <label>Categorías Asignadas</label>
          <div id="current-categories" class="tags-list">
            <div class="loading-cell">Cargando...</div>
          </div>
        </div>

        <div class="form-group">
          <label for="new-category">Agregar Categoría</label>
          <div class="add-category-group">
            <select id="new-category" class="form-input">
              <option value="">Seleccionar categoría...</option>
            </select>
            <button class="btn btn-primary" id="btn-add-category">Agregar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  import { authFetch } from '../../../lib/auth';

  let sections: any[] = [];
  let availableCategories: string[] = [];
  let currentSectionId: string | null = null;

  async function loadSections() {
    const container = document.getElementById('sections-list')!;
    container.innerHTML = '<div class="loading-cell">Cargando secciones...</div>';

    try {
      const r = await authFetch('/api/sections?include_inactive=true');
      if (!r.ok) throw new Error('Failed to load');

      const data = await r.json();
      sections = data.sections || [];

      if (sections.length === 0) {
        container.innerHTML = '<div class="empty-cell">No hay secciones creadas</div>';
        return;
      }

      container.innerHTML = sections.map((section: any) => `
        <div class="section-item ${!section.is_active ? 'inactive' : ''}">
          <div class="section-info">
            <div class="section-header-row">
              <div class="section-main">
                <span class="section-order">#${section.display_order}</span>
                ${section.icon ? `<span class="section-icon-text">${section.icon}</span>` : ''}
                <h3 class="section-name">${section.name}</h3>
                ${!section.is_active ? '<span class="badge badge-warning">Inactiva</span>' : ''}
              </div>
              <div class="section-stats">
                <span class="pub-count">${section.publication_count} publicaciones</span>
              </div>
            </div>
            ${section.description ? `<p class="section-desc">${section.description}</p>` : ''}
            <div class="section-meta">
              <span class="meta-item">Slug: <code>${section.slug}</code></span>
            </div>
          </div>
          <div class="section-actions">
            <button class="btn btn-small btn-secondary" data-action="categories" data-id="${section.id}">
              Categorías
            </button>
            <button class="btn btn-small btn-secondary" data-action="edit" data-id="${section.id}">
              Editar
            </button>
            <button class="btn btn-small btn-danger" data-action="delete" data-id="${section.id}">
              Eliminar
            </button>
          </div>
        </div>
      `).join('');

      setupSectionActions();
    } catch (e) {
      console.error('Error:', e);
      container.innerHTML = '<div class="error-cell">Error al cargar</div>';
    }
  }

  async function loadAvailableCategories() {
    try {
      const r = await authFetch('/api/sections/admin/available-categories');
      if (!r.ok) return;

      availableCategories = await r.json();
    } catch (e) {
      console.error('Error loading categories:', e);
    }
  }

  function setupSectionActions() {
    document.querySelectorAll('[data-action]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const target = e.target as HTMLButtonElement;
        const action = target.dataset.action;
        const id = target.dataset.id;

        if (action === 'edit') {
          openEditModal(id!);
        } else if (action === 'delete') {
          if (confirm('¿Eliminar esta sección? También se eliminarán sus categorías asignadas.')) {
            await deleteSection(id!);
          }
        } else if (action === 'categories') {
          openCategoriesModal(id!);
        }
      });
    });
  }

  function openEditModal(sectionId: string) {
    const section = sections.find(s => s.id === sectionId);
    if (!section) return;

    document.getElementById('modal-title')!.textContent = 'Editar Sección';
    (document.getElementById('section-id') as HTMLInputElement).value = sectionId;
    (document.getElementById('section-name') as HTMLInputElement).value = section.name;
    (document.getElementById('section-slug') as HTMLInputElement).value = section.slug;
    (document.getElementById('section-description') as HTMLTextAreaElement).value = section.description || '';
    (document.getElementById('section-icon') as HTMLInputElement).value = section.icon || '';
    (document.getElementById('section-order') as HTMLInputElement).value = section.display_order.toString();
    (document.getElementById('section-active') as HTMLInputElement).checked = section.is_active;

    document.getElementById('section-modal')!.classList.add('show');
  }

  function openNewModal() {
    document.getElementById('modal-title')!.textContent = 'Nueva Sección';
    (document.getElementById('section-form') as HTMLFormElement).reset();
    (document.getElementById('section-id') as HTMLInputElement).value = '';
    (document.getElementById('section-active') as HTMLInputElement).checked = true;

    document.getElementById('section-modal')!.classList.add('show');
  }

  async function openCategoriesModal(sectionId: string) {
    currentSectionId = sectionId;
    const section = sections.find(s => s.id === sectionId);
    if (!section) return;

    document.getElementById('categories-modal-title')!.textContent = `Categorías: ${section.name}`;
    (document.getElementById('categories-section-id') as HTMLInputElement).value = sectionId;

    document.getElementById('categories-modal')!.classList.add('show');

    await loadSectionCategories(sectionId);
    populateCategorySelect();
  }

  async function loadSectionCategories(sectionId: string) {
    const container = document.getElementById('current-categories')!;
    container.innerHTML = '<div class="loading-cell">Cargando...</div>';

    try {
      const r = await authFetch(`/api/sections/${sectionId}/detail`);
      if (!r.ok) throw new Error('Failed to load');

      const data = await r.json();
      const categories = data.categories || [];

      if (categories.length === 0) {
        container.innerHTML = '<div class="empty-cell">No hay categorías asignadas</div>';
        return;
      }

      container.innerHTML = categories.map((cat: string) => `
        <div class="tag">
          ${cat}
          <button class="tag-remove" data-category="${cat}">×</button>
        </div>
      `).join('');

      // Setup remove buttons
      container.querySelectorAll('.tag-remove').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const category = (e.target as HTMLElement).dataset.category!;
          await removeCategory(sectionId, category);
        });
      });
    } catch (e) {
      console.error('Error:', e);
      container.innerHTML = '<div class="error-cell">Error al cargar</div>';
    }
  }

  function populateCategorySelect() {
    const select = document.getElementById('new-category') as HTMLSelectElement;
    select.innerHTML = '<option value="">Seleccionar categoría...</option>';

    availableCategories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      select.appendChild(option);
    });
  }

  async function saveSection() {
    const id = (document.getElementById('section-id') as HTMLInputElement).value;
    const name = (document.getElementById('section-name') as HTMLInputElement).value.trim();
    const slug = (document.getElementById('section-slug') as HTMLInputElement).value.trim();
    const description = (document.getElementById('section-description') as HTMLTextAreaElement).value.trim();
    const icon = (document.getElementById('section-icon') as HTMLInputElement).value.trim();
    const displayOrder = parseInt((document.getElementById('section-order') as HTMLInputElement).value);
    const isActive = (document.getElementById('section-active') as HTMLInputElement).checked;

    if (!name || !slug) {
      alert('Nombre y slug son requeridos');
      return;
    }

    const data = {
      name,
      slug,
      description: description || null,
      icon: icon || null,
      display_order: displayOrder,
      is_active: isActive,
    };

    try {
      let r;
      if (id) {
        // Update
        r = await authFetch(`/api/sections/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
      } else {
        // Create
        r = await authFetch('/api/sections', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
      }

      if (!r.ok) {
        const error = await r.json();
        throw new Error(error.detail || 'Error al guardar');
      }

      closeModal();
      loadSections();
    } catch (e: any) {
      console.error('Error:', e);
      alert(e.message || 'Error al guardar');
    }
  }

  async function deleteSection(id: string) {
    try {
      const r = await authFetch(`/api/sections/${id}`, {
        method: 'DELETE',
      });

      if (!r.ok) throw new Error('Failed to delete');

      loadSections();
    } catch (e) {
      console.error('Error:', e);
      alert('Error al eliminar la sección');
    }
  }

  async function addCategory() {
    const sectionId = currentSectionId;
    if (!sectionId) return;

    const select = document.getElementById('new-category') as HTMLSelectElement;
    const category = select.value;

    if (!category) {
      alert('Selecciona una categoría');
      return;
    }

    try {
      const r = await authFetch(`/api/sections/${sectionId}/categories`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ category_name: category }),
      });

      if (!r.ok) {
        const error = await r.json();
        throw new Error(error.detail || 'Error al agregar');
      }

      select.value = '';
      loadSectionCategories(sectionId);
      loadSections(); // Refresh to update counts
    } catch (e: any) {
      console.error('Error:', e);
      alert(e.message || 'Error al agregar categoría');
    }
  }

  async function removeCategory(sectionId: string, category: string) {
    try {
      const r = await authFetch(`/api/sections/${sectionId}/categories/${encodeURIComponent(category)}`, {
        method: 'DELETE',
      });

      if (!r.ok) throw new Error('Failed to remove');

      loadSectionCategories(sectionId);
      loadSections(); // Refresh to update counts
    } catch (e) {
      console.error('Error:', e);
      alert('Error al eliminar categoría');
    }
  }

  function closeModal() {
    document.getElementById('section-modal')!.classList.remove('show');
    document.getElementById('categories-modal')!.classList.remove('show');
  }

  // Event listeners
  document.getElementById('btn-new-section')?.addEventListener('click', openNewModal);
  document.getElementById('btn-save')?.addEventListener('click', saveSection);
  document.getElementById('btn-cancel')?.addEventListener('click', closeModal);
  document.getElementById('modal-close')?.addEventListener('click', closeModal);
  document.getElementById('categories-modal-close')?.addEventListener('click', closeModal);
  document.getElementById('btn-add-category')?.addEventListener('click', addCategory);

  // Close modal on outside click
  window.addEventListener('click', (e) => {
    if ((e.target as HTMLElement).classList.contains('modal')) {
      closeModal();
    }
  });

  // Initial load
  document.addEventListener('DOMContentLoaded', () => {
    loadAvailableCategories();
    loadSections();
  });
</script>

<style>
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
  }

  .subtitle {
    color: var(--text-secondary);
    margin: 4px 0 0;
  }

  .sections-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .section-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
    padding: 20px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
  }

  .section-item:hover {
    background: var(--bg-card-hover);
    border-color: var(--border-medium);
  }

  .section-item.inactive {
    opacity: 0.6;
  }

  .section-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .section-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .section-main {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .section-order {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: rgba(59, 130, 246, 0.1);
    color: var(--accent-primary);
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 0.875rem;
  }

  .section-icon-text {
    padding: 6px 12px;
    background: var(--bg-card);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    color: var(--text-muted);
    font-family: monospace;
  }

  .section-name {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .section-desc {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.95rem;
  }

  .section-meta {
    display: flex;
    gap: 16px;
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .meta-item code {
    padding: 2px 6px;
    background: var(--bg-card);
    border-radius: 4px;
    font-size: 0.85rem;
  }

  .section-stats {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .pub-count {
    padding: 6px 12px;
    background: rgba(34, 197, 94, 0.1);
    color: var(--success);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    font-weight: 600;
  }

  .section-actions {
    display: flex;
    gap: 8px;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal.show {
    display: flex;
  }

  .modal-content {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-subtle);
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
  }

  .modal-close {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 2rem;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
  }

  .modal-close:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
  }

  .modal-body {
    padding: 24px;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 20px 24px;
    border-top: 1px solid var(--border-subtle);
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .form-group small {
    display: block;
    margin-top: 6px;
    color: var(--text-muted);
    font-size: 0.85rem;
  }

  .form-input {
    width: 100%;
    padding: 10px 14px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--accent-secondary);
    background: var(--bg-primary);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 10px 0;
  }

  .checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    min-height: 40px;
  }

  .tag {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(59, 130, 246, 0.1);
    color: var(--accent-primary);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
  }

  .tag-remove {
    background: none;
    border: none;
    color: var(--accent-primary);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
  }

  .tag-remove:hover {
    background: rgba(59, 130, 246, 0.2);
  }

  .add-category-group {
    display: flex;
    gap: 12px;
  }

  .add-category-group .form-input {
    flex: 1;
  }

  .loading-cell,
  .empty-cell,
  .error-cell {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
  }

  .error-cell {
    color: var(--error);
  }

  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      gap: 16px;
    }

    .section-item {
      flex-direction: column;
      gap: 16px;
    }

    .section-actions {
      width: 100%;
      justify-content: stretch;
    }

    .section-actions .btn {
      flex: 1;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .modal-content {
      width: 95%;
      max-height: 95vh;
    }

    .add-category-group {
      flex-direction: column;
    }
  }
</style>
