---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Noticias - Admin">
  <div class="page-header">
    <div>
      <h1 class="page-title">Noticias</h1>
      <p class="page-subtitle">Gestiona las publicaciones</p>
    </div>
  </div>

  <div class="tabs" id="state-tabs">
    <button class="tab active" data-state="all">Todas</button>
    <button class="tab" data-state="draft">Borradores</button>
    <button class="tab" data-state="published">Publicadas</button>
    <button class="tab featured-tab" data-state="featured">⭐ Destacadas</button>
    <button class="tab" data-state="discarded">Descartadas</button>
  </div>

  <!-- Filters Section -->
  <div class="filters-card card">
    <div class="filters-header">
      <h3 class="filters-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
          <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"></path>
        </svg>
        Filtros
      </h3>
      <button class="btn-text" id="btn-clear-filters">Limpiar filtros</button>
    </div>

    <div class="filters-grid">
      <!-- Search -->
      <div class="filter-group">
        <label for="filter-search" class="filter-label">Buscar</label>
        <input
          type="text"
          id="filter-search"
          class="filter-input"
          placeholder="Título, resumen o contenido..."
        />
      </div>

      <!-- Agent -->
      <div class="filter-group">
        <label for="filter-agent" class="filter-label">Agente</label>
        <select id="filter-agent" class="filter-select">
          <option value="">Todos los agentes</option>
        </select>
      </div>

      <!-- Category -->
      <div class="filter-group">
        <label for="filter-category" class="filter-label">Categoría</label>
        <input
          type="text"
          id="filter-category"
          class="filter-input"
          placeholder="ej: política, economía..."
        />
      </div>

      <!-- Date from -->
      <div class="filter-group">
        <label for="filter-date-from" class="filter-label">Desde fecha</label>
        <input
          type="date"
          id="filter-date-from"
          class="filter-input"
        />
      </div>

      <!-- Date to -->
      <div class="filter-group">
        <label for="filter-date-to" class="filter-label">Hasta fecha</label>
        <input
          type="date"
          id="filter-date-to"
          class="filter-input"
        />
      </div>

      <!-- Tags -->
      <div class="filter-group">
        <label for="filter-tags" class="filter-label">Tags</label>
        <input
          type="text"
          id="filter-tags"
          class="filter-input"
          placeholder="separados por comas"
        />
      </div>
    </div>

    <div class="filters-actions">
      <button class="btn btn-primary" id="btn-apply-filters">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
          <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        Aplicar Filtros
      </button>
    </div>
  </div>

  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>Título</th>
          <th>Agente</th>
          <th>Categoría</th>
          <th>Estado</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="publications-tbody">
        <tr>
          <td colspan="5" class="loading-cell">Cargando...</td>
        </tr>
      </tbody>
    </table>

    <div class="pagination" id="pagination"></div>
  </div>

  <!-- Featured Modal -->
  <div class="modal" id="featured-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="featured-modal-title">Destacar Publicación</h2>
        <button class="modal-close" id="featured-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="featured-pub-id" />
        <p id="featured-pub-title" class="featured-title"></p>

        <div class="form-group">
          <label for="featured-position">Posición (1-4)</label>
          <select id="featured-position" class="form-input">
            <option value="1">1 - Primera posición</option>
            <option value="2">2 - Segunda posición</option>
            <option value="3">3 - Tercera posición</option>
            <option value="4">4 - Cuarta posición</option>
          </select>
          <small>Máximo 4 noticias destacadas. Si la posición está ocupada, se intercambiará.</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="btn-featured-cancel">Cancelar</button>
        <button class="btn btn-danger" id="btn-featured-remove" style="display: none;">Quitar Destacado</button>
        <button class="btn btn-primary" id="btn-featured-save">Guardar</button>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  import { authFetch } from '../../../lib/auth';

  let currentState = 'all';
  let currentOffset = 0;
  const limit = 20;

  // Filter state
  let currentFilters = {
    search: '',
    agent: '',
    category: '',
    dateFrom: '',
    dateTo: '',
    tags: '',
  };

  async function loadPublications() {
    const tbody = document.getElementById('publications-tbody')!;
    tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">Cargando...</td></tr>';

    try {
      // Build URL with filters
      const params = new URLSearchParams();
      params.append('limit', String(limit));
      params.append('offset', String(currentOffset));

      if (currentState === 'featured') {
        // Filter for featured publications only
        params.append('is_featured', 'true');
        params.append('state', 'published'); // Featured are always published
      } else if (currentState !== 'all') {
        params.append('state', currentState);
      }

      if (currentFilters.search) {
        params.append('q', currentFilters.search);
      }

      if (currentFilters.agent) {
        params.append('agent_id', currentFilters.agent);
      }

      if (currentFilters.category) {
        params.append('category', currentFilters.category);
      }

      if (currentFilters.dateFrom) {
        params.append('from_date', currentFilters.dateFrom);
      }

      if (currentFilters.dateTo) {
        params.append('to_date', currentFilters.dateTo);
      }

      if (currentFilters.tags) {
        const tags = currentFilters.tags.split(',').map(t => t.trim()).filter(Boolean);
        tags.forEach(tag => params.append('tags', tag));
      }

      let url = `/api/publications/search?${params}`;

      const r = await authFetch(url);
      if (!r.ok) throw new Error('Failed to load');

      const data = await r.json();

      if (data.items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">No hay publicaciones</td></tr>';
        return;
      }

      tbody.innerHTML = data.items.map((p: any) => `
        <tr data-id="${p.id}">
          <td>
            <a href="/admin/noticias/${p.id}" class="title-link">${p.title}</a>
          </td>
          <td>
            ${p.agent ? `
              <div class="agent-cell">
                <span class="agent-name">${p.agent.name}</span>
              </div>
            ` : '<span class="text-muted">-</span>'}
          </td>
          <td>${p.category || '-'}</td>
          <td>
            <span class="badge badge-${getStateBadge(p.state)}">${p.state}</span>
          </td>
          <td>${formatDate(p.published_at || p.created_at)}</td>
          <td class="actions-cell">
            ${p.state === 'draft' ? `
              <button class="btn btn-small btn-success publish-btn" data-id="${p.id}">Publicar</button>
              <button class="btn btn-small btn-danger discard-btn" data-id="${p.id}">Descartar</button>
            ` : ''}
            ${p.state === 'discarded' ? `
              <button class="btn btn-small btn-secondary restore-btn" data-id="${p.id}">Restaurar</button>
            ` : ''}
            ${p.state === 'published' ? `
              ${p.is_featured ? `
                <button class="btn btn-small btn-success featured-btn" data-id="${p.id}" data-featured="true" title="Destacada en posición ${p.featured_order || '?'}">
                  ⭐ #${p.featured_order || '?'}
                </button>
              ` : `
                <button class="btn btn-small btn-secondary featured-btn" data-id="${p.id}" data-featured="false">
                  Destacar
                </button>
              `}
              <button class="btn btn-small btn-warning discard-btn" data-id="${p.id}">Descartar</button>
            ` : ''}
            <a href="/admin/noticias/${p.id}" class="btn btn-small btn-secondary">Editar</a>
          </td>
        </tr>
      `).join('');

      // Setup action buttons
      setupActionButtons();

      // Update pagination
      updatePagination(data.total, data.has_more);
    } catch (e) {
      console.error('Error:', e);
      tbody.innerHTML = '<tr><td colspan="6" class="error-cell">Error al cargar</td></tr>';
    }
  }

  function getStateBadge(state: string): string {
    switch (state) {
      case 'published': return 'success';
      case 'draft': return 'warning';
      case 'discarded': return 'error';
      default: return 'info';
    }
  }

  function formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
  }

  function updatePagination(total: number, hasMore: boolean) {
    const pagination = document.getElementById('pagination')!;
    const currentPage = Math.floor(currentOffset / limit) + 1;
    const totalPages = Math.ceil(total / limit);

    pagination.innerHTML = `
      <button class="btn btn-small btn-secondary" ${currentOffset === 0 ? 'disabled' : ''} id="prev-btn">Anterior</button>
      <span class="page-info">Pagina ${currentPage} de ${totalPages}</span>
      <button class="btn btn-small btn-secondary" ${!hasMore ? 'disabled' : ''} id="next-btn">Siguiente</button>
    `;

    document.getElementById('prev-btn')?.addEventListener('click', () => {
      if (currentOffset > 0) {
        currentOffset -= limit;
        loadPublications();
      }
    });

    document.getElementById('next-btn')?.addEventListener('click', () => {
      if (hasMore) {
        currentOffset += limit;
        loadPublications();
      }
    });
  }

  function setupActionButtons() {
    document.querySelectorAll('.publish-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        await changeState(id!, 'published');
      });
    });

    document.querySelectorAll('.discard-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        await changeState(id!, 'discarded');
      });
    });

    document.querySelectorAll('.restore-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        await restorePublication(id!);
      });
    });

    document.querySelectorAll('.featured-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        const isFeatured = btn.getAttribute('data-featured') === 'true';
        const row = btn.closest('tr');
        const title = row?.querySelector('.title-link')?.textContent || '';
        openFeaturedModal(id!, title, isFeatured);
      });
    });
  }

  async function changeState(id: string, state: string) {
    try {
      const r = await authFetch(`/api/publications/${id}/state`, {
        method: 'PATCH',
        body: JSON.stringify({ state }),
      });
      if (r.ok) {
        loadPublications();
      }
    } catch (e) {
      console.error('Error:', e);
    }
  }

  async function restorePublication(id: string) {
    try {
      const r = await authFetch(`/api/publications/${id}/restore`, {
        method: 'POST',
      });
      if (r.ok) {
        loadPublications();
      }
    } catch (e) {
      console.error('Error:', e);
    }
  }

  // Load agents for filter dropdown
  async function loadAgents() {
    try {
      const r = await authFetch('/api/agents');
      if (!r.ok) return;

      const agents = await r.json();
      const select = document.getElementById('filter-agent') as HTMLSelectElement;

      agents.forEach((agent: any) => {
        const option = document.createElement('option');
        option.value = agent.id;
        option.textContent = agent.name;
        select.appendChild(option);
      });
    } catch (e) {
      console.error('Error loading agents:', e);
    }
  }

  // Apply filters
  function applyFilters() {
    currentFilters.search = (document.getElementById('filter-search') as HTMLInputElement).value;
    currentFilters.agent = (document.getElementById('filter-agent') as HTMLSelectElement).value;
    currentFilters.category = (document.getElementById('filter-category') as HTMLInputElement).value;
    currentFilters.dateFrom = (document.getElementById('filter-date-from') as HTMLInputElement).value;
    currentFilters.dateTo = (document.getElementById('filter-date-to') as HTMLInputElement).value;
    currentFilters.tags = (document.getElementById('filter-tags') as HTMLInputElement).value;

    currentOffset = 0;
    loadPublications();
  }

  // Clear filters
  function clearFilters() {
    (document.getElementById('filter-search') as HTMLInputElement).value = '';
    (document.getElementById('filter-agent') as HTMLSelectElement).value = '';
    (document.getElementById('filter-category') as HTMLInputElement).value = '';
    (document.getElementById('filter-date-from') as HTMLInputElement).value = '';
    (document.getElementById('filter-date-to') as HTMLInputElement).value = '';
    (document.getElementById('filter-tags') as HTMLInputElement).value = '';

    currentFilters = {
      search: '',
      agent: '',
      category: '',
      dateFrom: '',
      dateTo: '',
      tags: '',
    };

    currentOffset = 0;
    loadPublications();
  }

  // Tab switching
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentState = tab.getAttribute('data-state') || 'all';
      currentOffset = 0;
      loadPublications();
    });
  });

  // Filter buttons
  document.getElementById('btn-apply-filters')?.addEventListener('click', applyFilters);
  document.getElementById('btn-clear-filters')?.addEventListener('click', clearFilters);

  // Press Enter to apply filters
  document.querySelectorAll('.filter-input').forEach(input => {
    input.addEventListener('keypress', (e) => {
      if ((e as KeyboardEvent).key === 'Enter') {
        applyFilters();
      }
    });
  });

  // Featured publications modal logic
  function openFeaturedModal(id: string, title: string, isFeatured: boolean) {
    const modal = document.getElementById('featured-modal')!;
    const titleEl = document.getElementById('featured-pub-title')!;
    const idInput = document.getElementById('featured-pub-id') as HTMLInputElement;
    const removeBtn = document.getElementById('btn-featured-remove')!;

    idInput.value = id;
    titleEl.textContent = title;

    if (isFeatured) {
      removeBtn.style.display = 'inline-block';
    } else {
      removeBtn.style.display = 'none';
    }

    modal.style.display = 'flex';
  }

  function closeFeaturedModal() {
    document.getElementById('featured-modal')!.style.display = 'none';
  }

  async function saveFeatured() {
    const id = (document.getElementById('featured-pub-id') as HTMLInputElement).value;
    const position = parseInt((document.getElementById('featured-position') as HTMLSelectElement).value);

    try {
      const r = await authFetch(`/api/publications/${id}/feature?featured_order=${position}`, {
        method: 'POST',
      });

      if (!r.ok) {
        const error = await r.json();
        throw new Error(error.detail || 'Error al destacar');
      }

      closeFeaturedModal();
      loadPublications();
    } catch (e: any) {
      console.error('Error:', e);
      alert(e.message || 'Error al destacar la publicación');
    }
  }

  async function removeFeatured() {
    const id = (document.getElementById('featured-pub-id') as HTMLInputElement).value;

    if (!confirm('¿Quitar esta publicación de destacadas?')) {
      return;
    }

    try {
      const r = await authFetch(`/api/publications/${id}/feature`, {
        method: 'DELETE',
      });

      if (!r.ok) throw new Error('Error al quitar destacado');

      closeFeaturedModal();
      loadPublications();
    } catch (e) {
      console.error('Error:', e);
      alert('Error al quitar el destacado');
    }
  }

  // Featured modal event listeners
  document.getElementById('featured-modal-close')?.addEventListener('click', closeFeaturedModal);
  document.getElementById('btn-featured-cancel')?.addEventListener('click', closeFeaturedModal);
  document.getElementById('btn-featured-save')?.addEventListener('click', saveFeatured);
  document.getElementById('btn-featured-remove')?.addEventListener('click', removeFeatured);

  // Close modal on outside click
  window.addEventListener('click', (e) => {
    if ((e.target as HTMLElement).id === 'featured-modal') {
      closeFeaturedModal();
    }
  });

  // Initial load
  document.addEventListener('DOMContentLoaded', () => {
    loadAgents();
    loadPublications();
  });
</script>

<style>
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
  }

  .tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    background: var(--bg-card);
    padding: 4px;
    border-radius: var(--radius-md);
    width: fit-content;
  }

  .tab {
    padding: 10px 20px;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .tab:hover {
    color: var(--text-primary);
  }

  .tab.active {
    background: var(--bg-secondary);
    color: var(--text-primary);
  }

  .tab.featured-tab {
    color: #f59e0b;
  }

  .tab.featured-tab.active {
    background: rgba(245, 158, 11, 0.15);
    color: #f59e0b;
  }

  .title-link {
    color: var(--text-primary);
    text-decoration: none;
    font-weight: 500;
  }

  .title-link:hover {
    color: var(--accent-secondary);
  }

  .actions-cell {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .btn-small {
    padding: 6px 12px;
    font-size: 0.8rem;
  }

  .loading-cell,
  .empty-cell,
  .error-cell {
    text-align: center;
    padding: 40px !important;
    color: var(--text-muted);
  }

  .pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border-subtle);
  }

  .page-info {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  /* Filters */
  .filters-card {
    margin-bottom: 24px;
  }

  .filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-subtle);
  }

  .filters-title {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .filters-title svg {
    color: var(--accent-secondary);
  }

  .btn-text {
    background: none;
    border: none;
    color: var(--accent-secondary);
    font-size: 0.9rem;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
  }

  .btn-text:hover {
    background: rgba(59, 130, 246, 0.1);
    color: var(--accent-primary);
  }

  .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .filter-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .filter-input,
  .filter-select {
    padding: 10px 14px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .filter-input:focus,
  .filter-select:focus {
    outline: none;
    border-color: var(--accent-secondary);
    background: var(--bg-primary);
  }

  .filter-input::placeholder {
    color: var(--text-muted);
  }

  .filters-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }

  .agent-cell {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .agent-name {
    font-size: 0.875rem;
    color: var(--text-primary);
  }

  .text-muted {
    color: var(--text-muted);
  }

  @media (max-width: 768px) {
    .tabs {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding: 4px;
    }

    .tab {
      padding: 8px 14px;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .card {
      padding: 12px;
      overflow-x: auto;
    }

    .table {
      min-width: 600px;
    }

    .table th,
    .table td {
      padding: 10px 8px;
      font-size: 0.85rem;
    }

    .title-link {
      display: block;
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .actions-cell {
      gap: 4px;
    }

    .btn-small {
      padding: 5px 8px;
      font-size: 0.75rem;
    }

    .pagination {
      flex-wrap: wrap;
      gap: 10px;
    }

    .page-info {
      width: 100%;
      text-align: center;
      order: -1;
    }

    .filters-grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .filters-actions {
      justify-content: stretch;
    }

    .filters-actions .btn {
      flex: 1;
    }
  }

  @media (max-width: 480px) {
    .tabs {
      gap: 2px;
    }

    .tab {
      padding: 6px 10px;
      font-size: 0.8rem;
    }

    .table {
      font-size: 0.8rem;
    }

    .badge {
      font-size: 0.65rem;
      padding: 2px 6px;
    }
  }

  /* Featured Modal Styles */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-subtle);
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
  }

  .modal-close {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 2rem;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
  }

  .modal-close:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
  }

  .modal-body {
    padding: 24px;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 20px 24px;
    border-top: 1px solid var(--border-subtle);
  }

  .featured-title {
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 20px 0;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .form-group small {
    display: block;
    margin-top: 6px;
    color: var(--text-muted);
    font-size: 0.85rem;
  }

  .form-input {
    width: 100%;
    padding: 10px 14px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--accent-secondary);
    background: var(--bg-primary);
  }
</style>
