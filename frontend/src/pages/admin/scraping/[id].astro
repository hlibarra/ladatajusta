---
import AdminLayout from '../../../layouts/AdminLayout.astro';

const { id } = Astro.params;
---

<AdminLayout title="Editar Item - Admin">
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <a href="/admin/scraping" class="back-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Volver a Scraping
        </a>
        <h1 class="page-title">Editar Item de Scraping</h1>
      </div>
      <div class="header-actions">
        <button id="btn-process-ai" class="btn btn-ai" style="display: none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
          Procesar con IA
        </button>
        <button id="btn-discard" class="btn btn-secondary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
          Descartar
        </button>
        <button id="btn-save" class="btn btn-primary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
            <polyline points="17 21 17 13 7 13 7 21"/>
            <polyline points="7 3 7 8 15 8"/>
          </svg>
          Guardar Cambios
        </button>
        <button id="btn-publish" class="btn btn-success" style="display: none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <path d="M22 2L11 13"/>
            <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
          </svg>
          Publicar
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="loading-state">
      <div class="spinner"></div>
      <p>Cargando item...</p>
    </div>

    <!-- Error State -->
    <div id="error-state" class="error-state" style="display: none;">
      <p id="error-message"></p>
    </div>

    <!-- Main Content -->
    <div id="main-content" style="display: none;">
      <!-- Info Cards -->
      <div class="info-grid">
        <div class="info-card">
          <div class="info-label">Estado</div>
          <div id="item-status" class="info-value"></div>
        </div>
        <div class="info-card">
          <div class="info-label">Medio</div>
          <div id="item-media" class="info-value"></div>
        </div>
        <div class="info-card">
          <div class="info-label">Sección</div>
          <div id="item-section" class="info-value"></div>
        </div>
        <div class="info-card">
          <div class="info-label">Fecha Artículo</div>
          <div id="item-date" class="info-value"></div>
        </div>
        <div class="info-card">
          <div class="info-label">Autor</div>
          <div id="item-author" class="info-value"></div>
        </div>
        <div class="info-card">
          <div class="info-label">Creado</div>
          <div id="item-created" class="info-value"></div>
        </div>
      </div>

      <!-- AI Processing Info -->
      <div id="ai-info-section" class="ai-info-section" style="display: none;">
        <h2 class="section-title-sm">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
          Información de Procesamiento IA
        </h2>
        <div class="ai-info-grid">
          <div class="ai-info-item">
            <span class="ai-info-label">Modelo:</span>
            <span id="ai-model" class="ai-info-value"></span>
          </div>
          <div class="ai-info-item">
            <span class="ai-info-label">Procesado:</span>
            <span id="ai-processed-date" class="ai-info-value"></span>
          </div>
          <div class="ai-info-item">
            <span class="ai-info-label">Tokens Usados:</span>
            <span id="ai-tokens" class="ai-info-value"></span>
          </div>
          <div class="ai-info-item">
            <span class="ai-info-label">Costo:</span>
            <span id="ai-cost" class="ai-info-value"></span>
          </div>
          <div class="ai-info-item">
            <span class="ai-info-label">Duración:</span>
            <span id="ai-duration" class="ai-info-value"></span>
          </div>
          <div class="ai-info-item">
            <span class="ai-info-label">Versión Prompt:</span>
            <span id="ai-prompt-version" class="ai-info-value"></span>
          </div>
        </div>
      </div>

      <!-- Typographic Cover Panel -->
      <div id="cover-panel" class="cover-panel" style="display: none;">
        <div class="cover-header">
          <h2 class="section-title-sm">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <path d="M7 7h10M7 12h10M7 17h6"/>
            </svg>
            Portada Tipográfica
          </h2>
          <p class="cover-description">
            Imagen editorial con <strong>1-3 palabras clave</strong> que definen la noticia.
            Sin fotos, sin ilustraciones, solo tipografía.
          </p>
        </div>

        <div class="cover-content">
          <!-- Keywords Editor -->
          <div class="keywords-editor">
            <label class="form-label">Palabras Clave (máximo 3)</label>
            <p class="keywords-hint">
              Ejemplos: "IMPUTABILIDAD", "DÓLAR BLUE", "CORTE SUPREMA"
            </p>

            <div class="keywords-inputs">
              <div class="keyword-input-group">
                <span class="keyword-number">1</span>
                <input type="text" id="keyword-1" class="keyword-input" placeholder="Palabra principal..." maxlength="30" />
              </div>
              <div class="keyword-input-group">
                <span class="keyword-number">2</span>
                <input type="text" id="keyword-2" class="keyword-input" placeholder="Segunda palabra (opcional)..." maxlength="30" />
              </div>
              <div class="keyword-input-group">
                <span class="keyword-number">3</span>
                <input type="text" id="keyword-3" class="keyword-input" placeholder="Tercera palabra (opcional)..." maxlength="30" />
              </div>
            </div>

            <button id="btn-suggest-keywords" class="btn btn-secondary btn-sm">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
              </svg>
              Sugerir automáticamente
            </button>

            <div id="category-indicator" class="category-indicator">
              <span class="category-label">Categoría:</span>
              <span id="category-value" class="category-value">-</span>
              <span class="category-color-hint">(define el color de la portada)</span>
            </div>
          </div>

          <!-- Image Preview -->
          <div class="cover-preview">
            <div id="cover-image-container" class="cover-image-container">
              <div id="cover-placeholder" class="cover-placeholder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <path d="M7 7h10M7 12h10M7 17h6"/>
                </svg>
                <p>La portada se generará aquí</p>
                <span class="placeholder-hint">Ingresa las palabras clave y genera</span>
              </div>
              <img id="cover-image" class="cover-image" style="display: none;" alt="Portada tipográfica" />
            </div>

            <div class="cover-actions">
              <button id="btn-generate-cover" class="btn btn-cover">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <path d="M7 7h10M7 12h10M7 17h6"/>
                </svg>
                Generar Portada
              </button>
              <button id="btn-regenerate-cover" class="btn btn-secondary" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                  <path d="M23 4v6h-6"/>
                  <path d="M1 20v-6h6"/>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
                Regenerar
              </button>
            </div>

            <div id="cover-meta" class="cover-meta" style="display: none;">
              <div class="meta-item">
                <span class="meta-label">Palabras:</span>
                <span id="meta-keywords" class="meta-value"></span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Generado en:</span>
                <span id="meta-duration" class="meta-value"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Generated Images (legacy view) -->
      <div id="images-section" class="images-section" style="display: none;">
        <h2 class="section-title-sm">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
          Imágenes Generadas por IA
        </h2>
        <div id="images-grid" class="images-grid"></div>
      </div>

      <!-- Edit Form -->
      <div class="edit-section">
        <h2 class="section-title">Contenido Principal</h2>

        <div class="form-group">
          <label class="form-label">Título (AI Generado)</label>
          <input type="text" id="ai-title" class="form-input" />
        </div>

        <div class="form-group">
          <label class="form-label">Resumen (AI Generado)</label>
          <textarea id="ai-summary" class="form-textarea" rows="3"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Categoría</label>
            <select id="ai-category" class="form-select">
              <option value="">Seleccionar...</option>
              <option value="Ciencia">Ciencia</option>
              <option value="Cultura">Cultura</option>
              <option value="Deportes">Deportes</option>
              <option value="Economía">Economía</option>
              <option value="Educación">Educación</option>
              <option value="Investigación">Investigación</option>
              <option value="Medio Ambiente">Medio Ambiente</option>
              <option value="Política">Política</option>
              <option value="Salud">Salud</option>
              <option value="Sociedad">Sociedad</option>
              <option value="Tecnología">Tecnología</option>
              <option value="Turismo">Turismo</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Tags</label>
            <div class="tags-editor">
              <div id="tags-container" class="tags-container"></div>
              <div class="tag-input-wrapper">
                <input
                  type="text"
                  id="tag-input"
                  class="tag-input"
                  placeholder="Agregar etiqueta..."
                  maxlength="64"
                />
                <button type="button" id="btn-add-tag" class="btn-add-tag" title="Agregar etiqueta">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <path d="M12 5v14M5 12h14"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Reading Levels -->
      <div class="edit-section">
        <h2 class="section-title">Niveles de Lectura</h2>

        <div class="reading-levels-edit">
          <!-- Sin Vueltas -->
          <div class="level-edit">
            <div class="level-header sin-vueltas">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
              </svg>
              <h3>Sin Vueltas</h3>
              <span class="level-desc">1-2 oraciones ultra directas (40-60 palabras)</span>
            </div>
            <textarea id="sin-vueltas" class="level-textarea" rows="3"></textarea>
          </div>

          <!-- Lo Central -->
          <div class="level-edit">
            <div class="level-header lo-central">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              <h3>Lo Central</h3>
              <span class="level-desc">Párrafo esencial con lo más importante (80-120 palabras)</span>
            </div>
            <textarea id="lo-central" class="level-textarea" rows="5"></textarea>
          </div>

          <!-- En Profundidad -->
          <div class="level-edit">
            <div class="level-header en-profundidad">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
              </svg>
              <h3>En Profundidad</h3>
              <span class="level-desc">Versión completa con contexto y detalles (200-300 palabras)</span>
            </div>
            <textarea id="en-profundidad" class="level-textarea" rows="8"></textarea>
          </div>
        </div>
      </div>

      <!-- Original Content (Read-only) -->
      <div class="edit-section">
        <h2 class="section-title">Contenido Original (Solo lectura)</h2>

        <div class="readonly-content">
          <div class="readonly-item">
            <strong>Título Original:</strong>
            <p id="original-title"></p>
          </div>
          <div class="readonly-item">
            <strong>Resumen Original:</strong>
            <p id="original-summary"></p>
          </div>
          <div class="readonly-item">
            <strong>Contenido Original:</strong>
            <div id="original-content" class="content-box"></div>
          </div>
          <div class="readonly-item">
            <strong>Fuente:</strong>
            <a id="source-url" href="" target="_blank" rel="noopener"></a>
          </div>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  import { authFetch } from '../../../lib/auth';

  const itemId = window.location.pathname.split('/').pop();
  let itemData: any = null;
  let currentTags: string[] = [];

  async function loadItem() {
    try {
      const response = await authFetch(`/api/scraping-items/${itemId}`);
      if (!response.ok) throw new Error('Failed to load item');

      itemData = await response.json();

      // Hide loading, show content
      document.getElementById('loading-state')!.style.display = 'none';
      document.getElementById('main-content')!.style.display = 'block';

      populateForm();
    } catch (error: any) {
      document.getElementById('loading-state')!.style.display = 'none';
      const errorState = document.getElementById('error-state')!;
      const errorMsg = document.getElementById('error-message')!;
      errorState.style.display = 'block';
      errorMsg.textContent = `Error: ${error.message}`;
    }
  }

  function populateForm() {
    // Info cards
    const statusBadge = `<span class="status-badge status-${itemData.status}">${getStatusLabel(itemData.status)}</span>`;
    document.getElementById('item-status')!.innerHTML = statusBadge;
    document.getElementById('item-media')!.textContent = getMediaLabel(itemData.source_media);
    document.getElementById('item-section')!.textContent = itemData.source_section || 'N/A';
    document.getElementById('item-date')!.textContent = itemData.article_date
      ? new Date(itemData.article_date).toLocaleDateString('es-AR')
      : 'N/A';
    document.getElementById('item-author')!.textContent = itemData.author || 'N/A';
    document.getElementById('item-created')!.textContent = itemData.created_at
      ? new Date(itemData.created_at).toLocaleDateString('es-AR', {
          year: 'numeric', month: 'short', day: 'numeric',
          hour: '2-digit', minute: '2-digit'
        })
      : 'N/A';

    // Editable fields
    (document.getElementById('ai-title') as HTMLInputElement).value = itemData.ai_title || '';
    (document.getElementById('ai-summary') as HTMLTextAreaElement).value = itemData.ai_summary || '';
    (document.getElementById('ai-category') as HTMLSelectElement).value = itemData.ai_category || '';

    // Tags
    currentTags = itemData.ai_tags || [];
    renderTags();

    // Reading levels
    (document.getElementById('sin-vueltas') as HTMLTextAreaElement).value =
      itemData.ai_metadata?.sin_vueltas || '';
    (document.getElementById('lo-central') as HTMLTextAreaElement).value =
      itemData.ai_metadata?.lo_central || '';
    (document.getElementById('en-profundidad') as HTMLTextAreaElement).value =
      itemData.ai_metadata?.en_profundidad || '';

    // Original content (readonly)
    document.getElementById('original-title')!.textContent = itemData.title || 'N/A';
    document.getElementById('original-summary')!.textContent = itemData.summary || 'N/A';
    document.getElementById('original-content')!.textContent = itemData.content || 'N/A';
    const sourceUrl = document.getElementById('source-url') as HTMLAnchorElement;
    sourceUrl.href = itemData.source_url || '#';
    sourceUrl.textContent = itemData.source_url || 'N/A';

    // Show publish button if applicable
    if (itemData.status === 'ai_completed' || itemData.status === 'ready_to_publish') {
      document.getElementById('btn-publish')!.style.display = 'inline-flex';
    }

    // Show AI info section if AI data exists
    if (itemData.ai_model) {
      document.getElementById('ai-info-section')!.style.display = 'block';
      document.getElementById('ai-model')!.textContent = itemData.ai_model;
      document.getElementById('ai-processed-date')!.textContent = itemData.ai_processed_at
        ? new Date(itemData.ai_processed_at).toLocaleDateString('es-AR', {
            year: 'numeric', month: 'short', day: 'numeric',
            hour: '2-digit', minute: '2-digit'
          })
        : 'N/A';
      document.getElementById('ai-tokens')!.textContent = itemData.ai_tokens_used
        ? itemData.ai_tokens_used.toLocaleString()
        : 'N/A';
      document.getElementById('ai-cost')!.textContent = itemData.ai_cost_usd
        ? `$${itemData.ai_cost_usd.toFixed(6)}`
        : 'N/A';
      document.getElementById('ai-duration')!.textContent = itemData.ai_processing_duration_ms
        ? `${itemData.ai_processing_duration_ms}ms`
        : 'N/A';
      document.getElementById('ai-prompt-version')!.textContent = itemData.ai_prompt_version || 'N/A';
    }

    // Show generated images if available
    if (itemData.image_urls && itemData.image_urls.length > 0) {
      document.getElementById('images-section')!.style.display = 'block';
      const imagesGrid = document.getElementById('images-grid')!;

      imagesGrid.innerHTML = itemData.image_urls.map((url: string, index: number) => `
        <div class="image-item">
          <img src="${url}" alt="Imagen generada ${index + 1}" loading="lazy" />
          <div class="image-info">
            <span class="image-label">Imagen ${index + 1}</span>
            ${itemData.ai_metadata?.image_generation ? `
              <div class="image-meta">
                <span class="image-meta-item">Modelo: ${itemData.ai_metadata.image_generation.model}</span>
                <span class="image-meta-item">Tamaño: ${itemData.ai_metadata.image_generation.size}</span>
                <span class="image-meta-item">Calidad: ${itemData.ai_metadata.image_generation.quality}</span>
                <span class="image-meta-item">Costo: $${itemData.ai_metadata.image_generation.cost_usd.toFixed(3)}</span>
              </div>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    // Show cover panel if AI-processed
    if (itemData.ai_title && itemData.ai_category) {
      document.getElementById('cover-panel')!.style.display = 'block';
      document.getElementById('category-value')!.textContent = itemData.ai_category;

      // Load saved keywords or suggest new ones
      if (itemData.ai_metadata?.cover_keywords) {
        const keywords = itemData.ai_metadata.cover_keywords;
        if (keywords[0]) (document.getElementById('keyword-1') as HTMLInputElement).value = keywords[0];
        if (keywords[1]) (document.getElementById('keyword-2') as HTMLInputElement).value = keywords[1];
        if (keywords[2]) (document.getElementById('keyword-3') as HTMLInputElement).value = keywords[2];
      }

      // If there's already an image, show it
      if (itemData.image_urls && itemData.image_urls.length > 0) {
        const img = document.getElementById('cover-image') as HTMLImageElement;
        const placeholder = document.getElementById('cover-placeholder')!;
        const regenerateBtn = document.getElementById('btn-regenerate-cover')!;
        const metaSection = document.getElementById('cover-meta')!;

        img.src = itemData.image_urls[0] + '?t=' + Date.now();
        img.style.display = 'block';
        placeholder.style.display = 'none';
        regenerateBtn.style.display = 'inline-flex';

        // Show metadata if available
        if (itemData.ai_metadata?.cover_generation) {
          const gen = itemData.ai_metadata.cover_generation;
          metaSection.style.display = 'flex';
          document.getElementById('meta-keywords')!.textContent = gen.keywords?.join(', ') || '-';
          document.getElementById('meta-duration')!.textContent = `${gen.duration_ms || 'N/A'}ms`;
        }
      }
    }

    // Show process AI button if item is not yet AI-processed
    if (!itemData.ai_title && (itemData.status === 'scraped' || itemData.status === 'ready_for_ai')) {
      document.getElementById('btn-process-ai')!.style.display = 'inline-flex';
    }
  }

  function getStatusLabel(status: string): string {
    const labels: Record<string, string> = {
      'scraped': 'Scrapeado',
      'ready_for_ai': 'Listo para IA',
      'ai_completed': 'IA OK',
      'ready_to_publish': 'Listo para Publicar',
      'published': 'Publicado',
      'error': 'Error',
      'discarded': 'Descartado'
    };
    return labels[status] || status;
  }

  function getMediaLabel(media: string): string {
    const labels: Record<string, string> = {
      'lagaceta': 'La Gaceta',
      'clarin': 'Clarín',
      'lanacion': 'La Nación'
    };
    return labels[media] || media;
  }

  function renderTags() {
    const container = document.getElementById('tags-container')!;
    container.innerHTML = '';

    currentTags.forEach((tag, index) => {
      const tagElement = document.createElement('div');
      tagElement.className = 'tag-badge';
      tagElement.innerHTML = `
        <span class="tag-text">${tag}</span>
        <button type="button" class="tag-remove" data-index="${index}" title="Eliminar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      `;
      container.appendChild(tagElement);
    });

    // Add event listeners to remove buttons
    container.querySelectorAll('.tag-remove').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const index = parseInt((e.currentTarget as HTMLElement).getAttribute('data-index')!);
        removeTag(index);
      });
    });
  }

  function addTag() {
    const input = document.getElementById('tag-input') as HTMLInputElement;
    const tag = input.value.trim();

    if (!tag) return;

    // Check if tag already exists
    if (currentTags.includes(tag)) {
      alert('Esta etiqueta ya existe');
      return;
    }

    // Limit to 10 tags
    if (currentTags.length >= 10) {
      alert('Máximo 10 etiquetas permitidas');
      return;
    }

    currentTags.push(tag);
    renderTags();
    input.value = '';
  }

  function removeTag(index: number) {
    currentTags.splice(index, 1);
    renderTags();
  }

  async function saveChanges() {
    try {
      const updates = {
        ai_title: (document.getElementById('ai-title') as HTMLInputElement).value,
        ai_summary: (document.getElementById('ai-summary') as HTMLTextAreaElement).value,
        ai_category: (document.getElementById('ai-category') as HTMLSelectElement).value,
        ai_tags: currentTags,
        ai_metadata: {
          ...itemData.ai_metadata,
          sin_vueltas: (document.getElementById('sin-vueltas') as HTMLTextAreaElement).value,
          lo_central: (document.getElementById('lo-central') as HTMLTextAreaElement).value,
          en_profundidad: (document.getElementById('en-profundidad') as HTMLTextAreaElement).value,
        }
      };

      const response = await authFetch(`/api/scraping-items/${itemId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updates)
      });

      if (!response.ok) throw new Error('Failed to save changes');

      alert('Cambios guardados exitosamente');
      await loadItem(); // Reload to show updated data
    } catch (error: any) {
      alert(`Error al guardar: ${error.message}`);
    }
  }

  async function publishItem() {
    // Check if item has images
    const hasImages = itemData.image_urls && itemData.image_urls.length > 0;

    if (!hasImages) {
      const confirmWithoutImage = confirm(
        'Esta publicación no tiene imagen.\n\n¿Deseas publicarla sin imagen de todos modos?'
      );
      if (!confirmWithoutImage) return;
    } else {
      if (!confirm('¿Publicar este artículo ahora?')) return;
    }

    try {
      const response = await authFetch(`/api/scraping-items/${itemId}/publish`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          agent_id: null,
          override_title: null,
          override_summary: null,
          override_body: null
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(errorText);
      }

      const result = await response.json();
      alert(`¡Publicación creada exitosamente!\n\nSlug: ${result.slug}`);
      window.location.href = '/admin/scraping';
    } catch (error: any) {
      alert(`Error al publicar: ${error.message}`);
    }
  }

  async function discardItem() {
    if (!confirm('¿Descartar este item? Esta acción no se puede deshacer.')) return;

    try {
      const response = await authFetch(`/api/scraping-items/${itemId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'discarded' })
      });

      if (!response.ok) throw new Error('Failed to discard item');

      alert('Item descartado');
      window.location.href = '/admin/scraping';
    } catch (error: any) {
      alert(`Error: ${error.message}`);
    }
  }

  async function processWithAI() {
    const btn = document.getElementById('btn-process-ai') as HTMLButtonElement;
    const originalHTML = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = `
      <svg class="spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
        <circle cx="12" cy="12" r="10" opacity="0.25"/>
        <path d="M12 2a10 10 0 0 1 10 10" opacity="0.75"/>
      </svg>
      Procesando...
    `;

    try {
      const response = await authFetch(`/api/scraping-items/${itemId}/process-ai`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Failed to process with AI');
      }

      const result = await response.json();

      if (result.is_valid) {
        alert(`¡Procesamiento IA completado!\n\nTítulo: ${result.ai_title}\nCategoría: ${result.ai_category}\nTokens: ${result.tokens_used}\nCosto: $${result.cost_usd.toFixed(6)}`);
      } else {
        alert(`Procesamiento completado pero el contenido fue marcado como no válido:\n\n${result.validation_reason}`);
      }

      // Reload the item to show the new AI data
      await loadItem();
    } catch (error: any) {
      alert(`Error al procesar con IA: ${error.message}`);
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  }

  // Get keywords from inputs
  function getKeywords(): string[] {
    const keywords: string[] = [];
    const kw1 = (document.getElementById('keyword-1') as HTMLInputElement).value.trim();
    const kw2 = (document.getElementById('keyword-2') as HTMLInputElement).value.trim();
    const kw3 = (document.getElementById('keyword-3') as HTMLInputElement).value.trim();
    if (kw1) keywords.push(kw1);
    if (kw2) keywords.push(kw2);
    if (kw3) keywords.push(kw3);
    return keywords;
  }

  async function suggestKeywords() {
    const btn = document.getElementById('btn-suggest-keywords') as HTMLButtonElement;
    btn.disabled = true;
    btn.textContent = 'Sugiriendo...';

    try {
      const response = await authFetch(`/api/scraping-items/${itemId}/suggest-keywords`);
      if (!response.ok) throw new Error('Failed to suggest keywords');

      const result = await response.json();
      const keywords = result.saved_keywords || result.suggested_keywords || [];

      if (keywords[0]) (document.getElementById('keyword-1') as HTMLInputElement).value = keywords[0];
      if (keywords[1]) (document.getElementById('keyword-2') as HTMLInputElement).value = keywords[1];
      if (keywords[2]) (document.getElementById('keyword-3') as HTMLInputElement).value = keywords[2];

    } catch (error: any) {
      alert(`Error: ${error.message}`);
    } finally {
      btn.disabled = false;
      btn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
          <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
        </svg>
        Sugerir automáticamente
      `;
    }
  }

  async function generateCoverImage() {
    const keywords = getKeywords();
    if (keywords.length === 0) {
      alert('Ingresa al menos una palabra clave');
      return;
    }

    const generateBtn = document.getElementById('btn-generate-cover') as HTMLButtonElement;
    const regenerateBtn = document.getElementById('btn-regenerate-cover') as HTMLButtonElement;

    const originalHTML = generateBtn.innerHTML;
    generateBtn.disabled = true;
    if (regenerateBtn) regenerateBtn.disabled = true;

    generateBtn.innerHTML = `
      <svg class="spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
        <circle cx="12" cy="12" r="10" opacity="0.25"/>
        <path d="M12 2a10 10 0 0 1 10 10" opacity="0.75"/>
      </svg>
      Generando...
    `;

    try {
      const keywordsParam = encodeURIComponent(keywords.join(','));
      const response = await authFetch(`/api/scraping-items/${itemId}/generate-cover?keywords=${keywordsParam}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Failed to generate cover');
      }

      const result = await response.json();

      // Update the image preview
      const img = document.getElementById('cover-image') as HTMLImageElement;
      const placeholder = document.getElementById('cover-placeholder')!;
      const metaSection = document.getElementById('cover-meta')!;

      img.src = result.image_url + '?t=' + Date.now();
      img.style.display = 'block';
      placeholder.style.display = 'none';
      regenerateBtn.style.display = 'inline-flex';

      // Update metadata
      metaSection.style.display = 'flex';
      document.getElementById('meta-keywords')!.textContent = result.keywords.join(', ');
      document.getElementById('meta-duration')!.textContent = `${result.metadata.duration_ms}ms`;

      // Update itemData
      itemData.image_urls = [result.image_url];
      if (!itemData.ai_metadata) itemData.ai_metadata = {};
      itemData.ai_metadata.cover_generation = result.metadata;
      itemData.ai_metadata.cover_keywords = result.keywords;

    } catch (error: any) {
      alert(`Error al generar portada: ${error.message}`);
    } finally {
      generateBtn.innerHTML = originalHTML;
      generateBtn.disabled = false;
      if (regenerateBtn) regenerateBtn.disabled = false;
    }
  }

  // Event listeners
  document.getElementById('btn-save')?.addEventListener('click', saveChanges);
  document.getElementById('btn-publish')?.addEventListener('click', publishItem);
  document.getElementById('btn-discard')?.addEventListener('click', discardItem);
  document.getElementById('btn-process-ai')?.addEventListener('click', processWithAI);
  document.getElementById('btn-generate-cover')?.addEventListener('click', generateCoverImage);
  document.getElementById('btn-regenerate-cover')?.addEventListener('click', generateCoverImage);
  document.getElementById('btn-suggest-keywords')?.addEventListener('click', suggestKeywords);

  // Tag management
  document.getElementById('btn-add-tag')?.addEventListener('click', addTag);
  document.getElementById('tag-input')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addTag();
    }
  });

  // Load on page load
  loadItem();
</script>

<style>
  .container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 2px solid var(--border-subtle);
  }

  .header-content {
    flex: 1;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.9rem;
    margin-bottom: 12px;
    transition: color 0.2s ease;
  }

  .back-link:hover {
    color: var(--accent-secondary);
  }

  .page-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
  }

  .header-actions {
    display: flex;
    gap: 12px;
  }

  .loading-state,
  .error-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-subtle);
    border-top-color: var(--accent-secondary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }

  .info-card {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 20px;
  }

  .info-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 8px;
  }

  .info-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .edit-section {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 32px;
    margin-bottom: 24px;
  }

  .section-title {
    font-size: 1.35rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 24px 0;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border-subtle);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .reading-levels-edit {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .level-edit {
    border: 2px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .level-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    font-weight: 700;
  }

  .level-header h3 {
    margin: 0;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .level-header.sin-vueltas {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.08));
    color: #dc2626;
    border-bottom: 2px solid rgba(239, 68, 68, 0.3);
  }

  .level-header.lo-central {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.08));
    color: #d97706;
    border-bottom: 2px solid rgba(245, 158, 11, 0.3);
  }

  .level-header.en-profundidad {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08));
    color: #16a34a;
    border-bottom: 2px solid rgba(34, 197, 94, 0.3);
  }

  .level-desc {
    margin-left: auto;
    font-size: 0.8rem;
    font-weight: 500;
    opacity: 0.8;
  }

  .level-textarea {
    width: 100%;
    padding: 20px;
    border: none;
    background: var(--bg-card);
    color: var(--text-primary);
    font-size: 1rem;
    line-height: 1.7;
    resize: vertical;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  .level-textarea:focus {
    outline: none;
    background: var(--bg-secondary);
  }

  .readonly-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .readonly-item strong {
    display: block;
    margin-bottom: 8px;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .readonly-item p {
    margin: 0;
    color: var(--text-primary);
    line-height: 1.6;
  }

  .content-box {
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .status-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border: 1.5px solid;
  }

  .status-scraped {
    background: rgba(139, 92, 246, 0.12);
    color: #8b5cf6;
    border-color: rgba(139, 92, 246, 0.3);
  }

  .status-ready_for_ai {
    background: rgba(59, 130, 246, 0.12);
    color: var(--accent-secondary);
    border-color: rgba(59, 130, 246, 0.3);
  }

  .status-ai_completed {
    background: rgba(34, 197, 94, 0.12);
    color: #22c55e;
    border-color: rgba(34, 197, 94, 0.3);
  }

  .status-ready_to_publish {
    background: rgba(16, 185, 129, 0.12);
    color: var(--success);
    border-color: rgba(16, 185, 129, 0.3);
  }

  .status-published {
    background: rgba(16, 185, 129, 0.12);
    color: var(--success);
    border-color: rgba(16, 185, 129, 0.3);
  }

  .ai-info-section {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(59, 130, 246, 0.05));
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: var(--radius-lg);
    padding: 28px 32px;
    margin-bottom: 24px;
  }

  .section-title-sm {
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 20px 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-title-sm svg {
    color: #8b5cf6;
  }

  .ai-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
  }

  .ai-info-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 14px 18px;
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
  }

  .ai-info-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .ai-info-value {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    word-break: break-word;
  }

  /* Tags Editor */
  .tags-editor {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    min-height: 44px;
    padding: 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
  }

  .tags-container:empty::before {
    content: 'No hay etiquetas agregadas';
    color: var(--text-muted);
    font-size: 0.9rem;
    font-style: italic;
  }

  .tag-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(99, 102, 241, 0.08));
    color: #6366f1;
    border: 1.5px solid rgba(99, 102, 241, 0.3);
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .tag-badge:hover {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(99, 102, 241, 0.12));
    border-color: rgba(99, 102, 241, 0.5);
    transform: translateY(-1px);
  }

  .tag-text {
    line-height: 1;
  }

  .tag-remove {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2px;
    background: none;
    border: none;
    color: currentColor;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s ease;
    border-radius: 50%;
  }

  .tag-remove:hover {
    opacity: 1;
    background: rgba(99, 102, 241, 0.15);
  }

  .tag-input-wrapper {
    display: flex;
    gap: 8px;
    align-items: stretch;
  }

  .tag-input {
    flex: 1;
    padding: 10px 14px;
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }

  .tag-input:focus {
    outline: none;
    border-color: var(--accent-secondary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .btn-add-tag {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 16px;
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
  }

  .btn-add-tag:hover {
    background: linear-gradient(135deg, #4f46e5, #4338ca);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
  }

  .btn-add-tag:active {
    transform: translateY(0);
  }

  @media (max-width: 768px) {
    .header {
      flex-direction: column;
      gap: 20px;
    }

    .header-actions {
      width: 100%;
      flex-wrap: wrap;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .level-desc {
      display: none;
    }

    .edit-section {
      padding: 20px;
    }

    .ai-info-section {
      padding: 20px;
    }

    .ai-info-grid {
      grid-template-columns: 1fr;
    }

    .tag-input-wrapper {
      flex-direction: column;
    }

    .btn-add-tag {
      width: 100%;
    }
  }

  /* Images Section */
  .images-section {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 32px;
  }

  .images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 20px;
    max-width: 600px;
  }

  .image-item {
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
    max-width: 300px;
  }

  .image-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
  }

  .image-item img {
    width: 100%;
    height: auto;
    max-height: 220px;
    object-fit: cover;
    display: block;
    background: #f5f5f5;
    cursor: pointer;
  }

  .image-item img:hover {
    opacity: 0.95;
  }

  .image-info {
    padding: 16px;
  }

  .image-label {
    font-weight: 600;
    color: var(--text-primary);
    display: block;
    margin-bottom: 8px;
  }

  .image-meta {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 8px;
  }

  .image-meta-item {
    font-size: 0.85rem;
    color: var(--text-muted);
    font-family: 'Courier New', monospace;
  }

  @media (max-width: 768px) {
    .images-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Spinner animation */
  .spinner {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  /* AI Processing Button */
  .btn-ai {
    background: linear-gradient(135deg, #8b5cf6, #6366f1);
    color: white;
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
  }

  .btn-ai:hover {
    background: linear-gradient(135deg, #7c3aed, #4f46e5);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
  }

  .btn-ai:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  /* ===== TYPOGRAPHIC COVER PANEL ===== */
  .cover-panel {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.98));
    border: 1px solid rgba(100, 116, 139, 0.3);
    border-radius: var(--radius-lg);
    padding: 32px;
    margin-bottom: 24px;
  }

  .cover-header {
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(100, 116, 139, 0.2);
  }

  .cover-header .section-title-sm {
    color: #e2e8f0;
    margin-bottom: 12px;
  }

  .cover-header .section-title-sm svg {
    color: #94a3b8;
  }

  .cover-description {
    color: #94a3b8;
    font-size: 0.95rem;
    line-height: 1.6;
    margin: 0;
  }

  .cover-description strong {
    color: #cbd5e1;
  }

  .cover-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
  }

  @media (max-width: 1024px) {
    .cover-content {
      grid-template-columns: 1fr;
    }
  }

  /* Keywords Editor */
  .keywords-editor {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .keywords-editor .form-label {
    color: #cbd5e1;
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0;
  }

  .keywords-hint {
    color: #64748b;
    font-size: 0.85rem;
    margin: 0;
    font-style: italic;
  }

  .keywords-inputs {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .keyword-input-group {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .keyword-number {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(99, 102, 241, 0.2);
    color: #818cf8;
    border-radius: 50%;
    font-size: 0.8rem;
    font-weight: 700;
    flex-shrink: 0;
  }

  .keyword-input {
    flex: 1;
    padding: 12px 16px;
    background: rgba(51, 65, 85, 0.5);
    border: 2px solid rgba(100, 116, 139, 0.2);
    border-radius: var(--radius-md);
    color: #e2e8f0;
    font-size: 1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    transition: all 0.2s ease;
  }

  .keyword-input::placeholder {
    color: #475569;
    font-weight: 400;
    text-transform: none;
  }

  .keyword-input:focus {
    outline: none;
    border-color: #6366f1;
    background: rgba(51, 65, 85, 0.7);
  }

  .btn-sm {
    padding: 8px 16px;
    font-size: 0.85rem;
  }

  .category-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: rgba(51, 65, 85, 0.3);
    border-radius: var(--radius-md);
    border: 1px solid rgba(100, 116, 139, 0.15);
    margin-top: 8px;
  }

  .category-label {
    color: #64748b;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .category-value {
    color: #818cf8;
    font-size: 0.9rem;
    font-weight: 600;
  }

  .category-color-hint {
    color: #475569;
    font-size: 0.75rem;
    margin-left: auto;
  }

  /* Cover Preview */
  .cover-preview {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .cover-image-container {
    background: rgba(15, 23, 42, 0.6);
    border: 2px dashed rgba(100, 116, 139, 0.3);
    border-radius: var(--radius-lg);
    min-height: 280px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
  }

  .cover-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    color: #64748b;
    text-align: center;
    padding: 40px;
  }

  .cover-placeholder svg {
    opacity: 0.5;
  }

  .cover-placeholder p {
    margin: 0;
    font-size: 1rem;
    color: #94a3b8;
  }

  .placeholder-hint {
    font-size: 0.85rem;
    color: #475569;
  }

  .cover-image {
    width: 100%;
    height: auto;
    max-height: 400px;
    object-fit: contain;
    display: block;
  }

  .cover-actions {
    display: flex;
    gap: 12px;
  }

  .btn-cover {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    color: white;
    border: none;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    flex: 1;
  }

  .btn-cover:hover {
    background: linear-gradient(135deg, #4f46e5, #4338ca);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
  }

  .btn-cover:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .cover-meta {
    display: flex;
    gap: 24px;
    padding: 14px 18px;
    background: rgba(51, 65, 85, 0.3);
    border-radius: var(--radius-md);
    border: 1px solid rgba(100, 116, 139, 0.15);
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .meta-label {
    color: #64748b;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .meta-value {
    color: #cbd5e1;
    font-size: 0.85rem;
    font-weight: 600;
    font-family: 'Courier New', monospace;
  }
</style>
