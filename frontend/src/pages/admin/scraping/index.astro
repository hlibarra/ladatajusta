---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Items Scrapeados - Admin">
  <div class="page-header">
    <div>
      <h1 class="page-title">Items Scrapeados</h1>
      <p class="page-subtitle">Gestión de contenido scrapeado antes de publicación</p>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid" id="stats-grid">
    <div class="stat-card">
      <div class="stat-icon scraped">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value" id="stat-scraped">-</span>
        <span class="stat-label">Scrapeados</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon ready">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value" id="stat-ready-ai">-</span>
        <span class="stat-label">Listos para IA</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon completed">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value" id="stat-published">-</span>
        <span class="stat-label">Publicados</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon error">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value" id="stat-errors">-</span>
        <span class="stat-label">Con errores</span>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="filter-group">
      <label for="filter-status">Estado:</label>
      <select id="filter-status" class="filter-select">
        <option value="">Todos</option>
        <option value="scraped">Scrapeado</option>
        <option value="pending_review">Pendiente revisión</option>
        <option value="ready_for_ai">Listo para IA</option>
        <option value="processing_ai">Procesando IA</option>
        <option value="ai_completed">IA completado</option>
        <option value="ready_to_publish">Listo para publicar</option>
        <option value="published">Publicado</option>
        <option value="discarded">Descartado</option>
        <option value="error">Error</option>
        <option value="duplicate">Duplicado</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="filter-media">Medio:</label>
      <select id="filter-media" class="filter-select">
        <option value="">Todos</option>
        <option value="lagaceta">La Gaceta</option>
        <option value="clarin">Clarín</option>
        <option value="infobae">Infobae</option>
        <option value="lanacion">La Nación</option>
        <option value="pagina12">Página 12</option>
        <option value="perfil">Perfil</option>
        <option value="other">Otros</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="filter-search">Buscar:</label>
      <input
        type="text"
        id="filter-search"
        class="filter-input"
        placeholder="Buscar en título o contenido..."
      />
    </div>

    <button id="btn-apply-filters" class="btn btn-primary">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      Filtrar
    </button>

    <button id="btn-clear-filters" class="btn btn-secondary">
      Limpiar
    </button>
  </div>

  <!-- Items Table -->
  <div class="card">
    <div class="table-header">
      <h3 class="card-title">Items Scrapeados</h3>
      <div class="table-actions">
        <button id="btn-refresh" class="btn btn-secondary btn-sm">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
          Actualizar
        </button>
      </div>
    </div>

    <div class="table-container">
      <div id="loading-state" class="loading-state">
        <div class="spinner"></div>
        <p>Cargando items...</p>
      </div>

      <div id="empty-state" class="empty-state" style="display: none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <p>No se encontraron items</p>
      </div>

      <table id="items-table" class="table" style="display: none;">
        <thead>
          <tr>
            <th style="width: 100px;">Estado</th>
            <th style="width: 120px;">Medio</th>
            <th>Título</th>
            <th style="width: 140px;">Fecha</th>
            <th style="width: 180px;">Acciones</th>
          </tr>
        </thead>
        <tbody id="items-tbody">
          <!-- Populated by JS -->
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div id="pagination-container" class="pagination" style="display: none;">
      <button id="btn-prev-page" class="btn btn-secondary btn-sm" disabled>
        Anterior
      </button>
      <span id="pagination-info" class="pagination-info">-</span>
      <button id="btn-next-page" class="btn btn-secondary btn-sm" disabled>
        Siguiente
      </button>
    </div>
  </div>

  <!-- Modal for item details -->
  <div id="item-modal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="modal-title">Detalles del Item</h2>
        <button id="modal-close" class="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Populated by JS -->
      </div>
      <div class="modal-footer">
        <button id="modal-close-btn" class="btn btn-secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal for publishing -->
  <div id="publish-modal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>Publicar Item</h2>
        <button id="publish-modal-close" class="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="publish-modal-body">
        <div class="publish-preview">
          <div class="alert alert-info">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <p>Estás por crear una publicación con este contenido. Revisa los datos antes de confirmar.</p>
          </div>

          <div class="detail-section">
            <h3>Contenido a Publicar</h3>
            <div class="detail-field">
              <strong>Título:</strong>
              <p id="publish-title">-</p>
            </div>
            <div class="detail-field">
              <strong>Resumen:</strong>
              <p id="publish-summary">-</p>
            </div>
            <div class="detail-field">
              <strong>Contenido:</strong>
              <div class="content-preview" id="publish-content">-</div>
            </div>
            <div class="detail-field">
              <strong>Medio:</strong>
              <p id="publish-source">-</p>
            </div>
            <div class="detail-field">
              <strong>Tags:</strong>
              <div class="tags-list" id="publish-tags"></div>
            </div>
          </div>

          <div class="detail-section">
            <h3>Opciones de Publicación</h3>
            <div class="form-group">
              <label class="form-label" for="publish-agent">Agente (opcional):</label>
              <select id="publish-agent" class="form-select">
                <option value="">Sin agente</option>
                <!-- Se llena dinámicamente -->
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="publish-cancel-btn" class="btn btn-secondary">Cancelar</button>
        <button id="publish-confirm-btn" class="btn btn-success">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <path d="M22 2L11 13"></path>
            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
          </svg>
          Publicar Ahora
        </button>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  import { authFetch } from '../../../lib/auth';

  interface ScrapingItem {
    id: string;
    source_media: string;
    source_section: string | null;
    source_url: string;
    title: string | null;
    subtitle: string | null;
    summary: string | null;
    content: string;
    author: string | null;
    article_date: string | null;
    tags: string[];
    status: string;
    status_updated_at: string;
    status_message: string | null;
    scraped_at: string;
    ai_title: string | null;
    ai_summary: string | null;
    ai_category: string | null;
    retry_count: number;
    last_error: string | null;
    publication_id: string | null;
  }

  let currentPage = 0;
  const pageSize = 20;
  let totalItems = 0;
  let currentFilters = {
    status: '',
    source_media: '',
    search_text: '',
  };

  // Load stats
  async function loadStats() {
    try {
      const response = await authFetch('/api/scraping-items/stats/summary');
      if (!response.ok) throw new Error('Failed to fetch stats');

      const data = await response.json();

      document.getElementById('stat-scraped')!.textContent = String(data.by_status.scraped || 0);
      document.getElementById('stat-ready-ai')!.textContent = String(data.items_ready_for_ai || 0);
      document.getElementById('stat-published')!.textContent = String(data.by_status.published || 0);
      document.getElementById('stat-errors')!.textContent = String(data.items_with_errors || 0);
    } catch (e) {
      console.error('Error loading stats:', e);
    }
  }

  // Load items
  async function loadItems() {
    const loadingState = document.getElementById('loading-state')!;
    const emptyState = document.getElementById('empty-state')!;
    const table = document.getElementById('items-table')!;
    const tbody = document.getElementById('items-tbody')!;
    const pagination = document.getElementById('pagination-container')!;

    loadingState.style.display = 'flex';
    table.style.display = 'none';
    emptyState.style.display = 'none';
    pagination.style.display = 'none';

    try {
      const params = new URLSearchParams({
        limit: String(pageSize),
        offset: String(currentPage * pageSize),
      });

      if (currentFilters.status) params.append('status', currentFilters.status);
      if (currentFilters.source_media) params.append('source_media', currentFilters.source_media);
      if (currentFilters.search_text) params.append('search_text', currentFilters.search_text);

      const response = await authFetch(`/api/scraping-items?${params}`);
      if (!response.ok) throw new Error('Failed to fetch items');

      const data = await response.json();
      totalItems = data.total;

      loadingState.style.display = 'none';

      if (data.items.length === 0) {
        emptyState.style.display = 'flex';
        return;
      }

      tbody.innerHTML = data.items.map((item: ScrapingItem) => `
        <tr data-item-id="${item.id}">
          <td>
            <span class="status-badge status-${item.status}">
              ${getStatusLabel(item.status)}
            </span>
          </td>
          <td>
            <span class="media-badge">${getMediaLabel(item.source_media)}</span>
          </td>
          <td>
            <div class="item-title">${item.title || item.ai_title || '(Sin título)'}</div>
            ${item.source_section ? `<div class="item-section">${item.source_section}</div>` : ''}
          </td>
          <td>
            <div class="item-date">${formatDate(item.scraped_at)}</div>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon" onclick="viewItem('${item.id}')" title="Ver detalles">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </button>
              ${getActionButtons(item)}
            </div>
          </td>
        </tr>
      `).join('');

      table.style.display = 'table';
      pagination.style.display = 'flex';
      updatePagination();
    } catch (e) {
      console.error('Error loading items:', e);
      loadingState.style.display = 'none';
      emptyState.style.display = 'flex';
      emptyState.querySelector('p')!.textContent = 'Error al cargar items';
    }
  }

  function getStatusLabel(status: string): string {
    const labels: Record<string, string> = {
      scraped: 'Scrapeado',
      pending_review: 'Pendiente',
      ready_for_ai: 'Listo IA',
      processing_ai: 'Procesando',
      ai_completed: 'IA OK',
      ready_to_publish: 'Listo',
      published: 'Publicado',
      discarded: 'Descartado',
      error: 'Error',
      duplicate: 'Duplicado',
    };
    return labels[status] || status;
  }

  function getMediaLabel(media: string): string {
    const labels: Record<string, string> = {
      lagaceta: 'La Gaceta',
      clarin: 'Clarín',
      infobae: 'Infobae',
      lanacion: 'La Nación',
      pagina12: 'Página 12',
      perfil: 'Perfil',
    };
    return labels[media] || media;
  }

  function getActionButtons(item: ScrapingItem): string {
    const buttons = [];

    if (item.status === 'scraped') {
      buttons.push(`
        <button class="btn-icon btn-success" onclick="updateStatus('${item.id}', 'ready_for_ai')" title="Marcar listo para IA">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </button>
      `);
    }

    if (item.status === 'error') {
      buttons.push(`
        <button class="btn-icon btn-warning" onclick="updateStatus('${item.id}', 'ready_for_ai')" title="Reintentar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
        </button>
      `);
    }

    // Botón Publicar - solo si tiene contenido listo
    if (item.status === 'scraped' || item.status === 'ready_for_ai' || item.status === 'ai_completed' || item.status === 'ready_to_publish') {
      buttons.push(`
        <button class="btn-icon btn-publish" onclick="openPublishModal('${item.id}')" title="Publicar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M22 2L11 13"></path>
            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
          </svg>
        </button>
      `);
    }

    if (item.status !== 'published' && item.status !== 'discarded') {
      buttons.push(`
        <button class="btn-icon btn-danger" onclick="updateStatus('${item.id}', 'discarded')" title="Descartar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      `);
    }

    return buttons.join('');
  }

  function formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffHours = diffMs / (1000 * 60 * 60);

    if (diffHours < 1) {
      const diffMins = Math.floor(diffMs / (1000 * 60));
      return `Hace ${diffMins} min`;
    } else if (diffHours < 24) {
      return `Hace ${Math.floor(diffHours)}h`;
    } else {
      return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }
  }

  function updatePagination() {
    const info = document.getElementById('pagination-info')!;
    const prevBtn = document.getElementById('btn-prev-page') as HTMLButtonElement;
    const nextBtn = document.getElementById('btn-next-page') as HTMLButtonElement;

    const start = currentPage * pageSize + 1;
    const end = Math.min((currentPage + 1) * pageSize, totalItems);

    info.textContent = `${start}-${end} de ${totalItems}`;

    prevBtn.disabled = currentPage === 0;
    nextBtn.disabled = end >= totalItems;
  }

  // View item details
  (window as any).viewItem = async function(itemId: string) {
    const modal = document.getElementById('item-modal')!;
    const modalBody = document.getElementById('modal-body')!;

    modal.style.display = 'flex';
    modalBody.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Cargando...</p></div>';

    try {
      const response = await authFetch(`/api/scraping-items/${itemId}`);
      if (!response.ok) throw new Error('Failed to fetch item');

      const item = await response.json();

      modalBody.innerHTML = `
        <div class="item-details">
          <div class="detail-section">
            <h3>Información General</h3>
            <div class="detail-grid">
              <div><strong>ID:</strong> ${item.id}</div>
              <div><strong>Estado:</strong> <span class="status-badge status-${item.status}">${getStatusLabel(item.status)}</span></div>
              <div><strong>Medio:</strong> ${getMediaLabel(item.source_media)}</div>
              <div><strong>Sección:</strong> ${item.source_section || 'N/A'}</div>
              <div><strong>Autor:</strong> ${item.author || 'N/A'}</div>
              <div><strong>Scrapeado:</strong> ${new Date(item.scraped_at).toLocaleString('es-AR')}</div>
            </div>
          </div>

          <div class="detail-section">
            <h3>Contenido Original</h3>
            <div class="detail-field">
              <strong>Título:</strong>
              <p>${item.title || 'N/A'}</p>
            </div>
            ${item.subtitle ? `
              <div class="detail-field">
                <strong>Subtítulo:</strong>
                <p>${item.subtitle}</p>
              </div>
            ` : ''}
            <div class="detail-field">
              <strong>Resumen:</strong>
              <p>${item.summary || 'N/A'}</p>
            </div>
            <div class="detail-field">
              <strong>Contenido:</strong>
              <div class="content-preview">${item.content.substring(0, 500)}${item.content.length > 500 ? '...' : ''}</div>
            </div>
            <div class="detail-field">
              <strong>URL:</strong>
              <a href="${item.source_url}" target="_blank" rel="noopener">${item.source_url}</a>
            </div>
            ${item.tags && item.tags.length > 0 ? `
              <div class="detail-field">
                <strong>Tags:</strong>
                <div class="tags-list">
                  ${item.tags.map((tag: string) => `<span class="tag">${tag}</span>`).join('')}
                </div>
              </div>
            ` : ''}
          </div>

          ${item.ai_title || item.ai_summary ? `
            <div class="detail-section">
              <h3>Contenido Generado por IA</h3>
              ${item.ai_title ? `
                <div class="detail-field">
                  <strong>Título IA:</strong>
                  <p>${item.ai_title}</p>
                </div>
              ` : ''}
              ${item.ai_summary ? `
                <div class="detail-field">
                  <strong>Resumen IA:</strong>
                  <p>${item.ai_summary}</p>
                </div>
              ` : ''}
              ${item.ai_category ? `
                <div class="detail-field">
                  <strong>Categoría IA:</strong>
                  <p>${item.ai_category}</p>
                </div>
              ` : ''}
              ${item.ai_model ? `
                <div class="detail-field">
                  <strong>Modelo:</strong>
                  <p>${item.ai_model}</p>
                </div>
              ` : ''}
            </div>
          ` : ''}

          ${item.last_error ? `
            <div class="detail-section error-section">
              <h3>Error</h3>
              <div class="detail-field">
                <strong>Mensaje:</strong>
                <pre class="error-message">${item.last_error}</pre>
              </div>
              <div class="detail-field">
                <strong>Intentos:</strong>
                <p>${item.retry_count} / ${item.max_retries}</p>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    } catch (e) {
      console.error('Error loading item:', e);
      modalBody.innerHTML = '<p class="error-text">Error al cargar detalles del item</p>';
    }
  };

  // Update item status
  (window as any).updateStatus = async function(itemId: string, newStatus: string) {
    if (!confirm(`¿Cambiar estado a "${getStatusLabel(newStatus)}"?`)) return;

    try {
      const response = await authFetch(`/api/scraping-items/${itemId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus }),
      });

      if (!response.ok) throw new Error('Failed to update status');

      await loadItems();
      await loadStats();
    } catch (e) {
      console.error('Error updating status:', e);
      alert('Error al actualizar el estado');
    }
  };

  // ===== PUBLISH FUNCTIONS =====

  let currentPublishItemId: string | null = null;
  let currentPublishItem: any = null;

  // Open publish modal
  (window as any).openPublishModal = async function(itemId: string) {
    currentPublishItemId = itemId;

    const modal = document.getElementById('publish-modal')!;
    modal.style.display = 'flex';

    // Load item data
    try {
      const response = await authFetch(`/api/scraping-items/${itemId}`);
      if (!response.ok) throw new Error('Failed to fetch item');

      currentPublishItem = await response.json();

      // Populate preview
      const title = currentPublishItem.ai_title || currentPublishItem.title || '(Sin título)';
      const summary = currentPublishItem.ai_summary || currentPublishItem.summary || '(Sin resumen)';
      const content = currentPublishItem.content;
      const source = getMediaLabel(currentPublishItem.source_media);
      const tags = currentPublishItem.ai_tags || currentPublishItem.tags || [];

      document.getElementById('publish-title')!.textContent = title;
      document.getElementById('publish-summary')!.textContent = summary;
      document.getElementById('publish-content')!.textContent = content.substring(0, 500) + (content.length > 500 ? '...' : '');
      document.getElementById('publish-source')!.textContent = source;

      const tagsContainer = document.getElementById('publish-tags')!;
      if (tags.length > 0) {
        tagsContainer.innerHTML = tags.map((tag: string) => `<span class="tag">${tag}</span>`).join('');
      } else {
        tagsContainer.innerHTML = '<span class="text-muted">Sin tags</span>';
      }

      // Load agents
      await loadAgents();

    } catch (e) {
      console.error('Error loading item for publish:', e);
      alert('Error al cargar el item');
      modal.style.display = 'none';
    }
  };

  // Load agents for selection
  async function loadAgents() {
    try {
      const response = await authFetch('/api/agents');
      if (!response.ok) return;

      const agents = await response.json();
      const select = document.getElementById('publish-agent') as HTMLSelectElement;

      // Clear existing options (except first)
      while (select.options.length > 1) {
        select.remove(1);
      }

      // Add agents
      agents.forEach((agent: any) => {
        const option = document.createElement('option');
        option.value = agent.id;
        option.textContent = agent.name;
        select.appendChild(option);
      });
    } catch (e) {
      console.error('Error loading agents:', e);
    }
  }

  // Publish item
  async function publishItem() {
    if (!currentPublishItemId) return;

    const confirmBtn = document.getElementById('publish-confirm-btn') as HTMLButtonElement;
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Publicando...';

    try {
      const agentSelect = document.getElementById('publish-agent') as HTMLSelectElement;
      const agentValue = agentSelect.value;

      // Prepare request body - all fields as null if not provided
      const requestBody = {
        agent_id: agentValue || null,
        override_title: null,
        override_summary: null,
        override_body: null
      };

      console.log('Publishing item:', currentPublishItemId);
      console.log('Request body:', requestBody);
      console.log('Request body JSON:', JSON.stringify(requestBody));

      const response = await authFetch(`/api/scraping-items/${currentPublishItemId}/publish`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody),
      });

      console.log('Response status:', response.status);
      console.log('Response ok:', response.ok);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Error response:', errorText);
        let errorDetail = 'Error al publicar';
        try {
          const errorJson = JSON.parse(errorText);
          errorDetail = errorJson.detail || JSON.stringify(errorJson);
        } catch {
          errorDetail = errorText;
        }
        throw new Error(errorDetail);
      }

      const result = await response.json();

      // Close modal
      document.getElementById('publish-modal')!.style.display = 'none';

      // Show success message
      alert(`¡Publicación creada exitosamente!\n\nSlug: ${result.slug}\nID: ${result.publication_id}`);

      // Reload items and stats
      await loadItems();
      await loadStats();

    } catch (e: any) {
      console.error('Error publishing:', e);
      alert(`Error al publicar: ${e.message}`);
    } finally {
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
          <path d="M22 2L11 13"></path>
          <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
        </svg>
        Publicar Ahora
      `;
    }
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    loadItems();

    document.getElementById('btn-apply-filters')!.addEventListener('click', () => {
      currentFilters.status = (document.getElementById('filter-status') as HTMLSelectElement).value;
      currentFilters.source_media = (document.getElementById('filter-media') as HTMLSelectElement).value;
      currentFilters.search_text = (document.getElementById('filter-search') as HTMLInputElement).value;
      currentPage = 0;
      loadItems();
    });

    document.getElementById('btn-clear-filters')!.addEventListener('click', () => {
      (document.getElementById('filter-status') as HTMLSelectElement).value = '';
      (document.getElementById('filter-media') as HTMLSelectElement).value = '';
      (document.getElementById('filter-search') as HTMLInputElement).value = '';
      currentFilters = { status: '', source_media: '', search_text: '' };
      currentPage = 0;
      loadItems();
    });

    document.getElementById('btn-refresh')!.addEventListener('click', () => {
      loadItems();
      loadStats();
    });

    document.getElementById('btn-prev-page')!.addEventListener('click', () => {
      if (currentPage > 0) {
        currentPage--;
        loadItems();
      }
    });

    document.getElementById('btn-next-page')!.addEventListener('click', () => {
      if ((currentPage + 1) * pageSize < totalItems) {
        currentPage++;
        loadItems();
      }
    });

    document.getElementById('modal-close')!.addEventListener('click', () => {
      document.getElementById('item-modal')!.style.display = 'none';
    });

    document.getElementById('modal-close-btn')!.addEventListener('click', () => {
      document.getElementById('item-modal')!.style.display = 'none';
    });

    // Close modal on outside click
    document.getElementById('item-modal')!.addEventListener('click', (e) => {
      if (e.target === document.getElementById('item-modal')) {
        document.getElementById('item-modal')!.style.display = 'none';
      }
    });

    // Publish modal event listeners
    document.getElementById('publish-modal-close')!.addEventListener('click', () => {
      document.getElementById('publish-modal')!.style.display = 'none';
    });

    document.getElementById('publish-cancel-btn')!.addEventListener('click', () => {
      document.getElementById('publish-modal')!.style.display = 'none';
    });

    document.getElementById('publish-confirm-btn')!.addEventListener('click', () => {
      publishItem();
    });

    // Close publish modal on outside click
    document.getElementById('publish-modal')!.addEventListener('click', (e) => {
      if (e.target === document.getElementById('publish-modal')) {
        document.getElementById('publish-modal')!.style.display = 'none';
      }
    });
  });
</script>

<style>
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }

  .stat-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 24px;
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .stat-icon.scraped {
    background: rgba(139, 92, 246, 0.15);
    color: #8b5cf6;
  }

  .stat-icon.ready {
    background: rgba(59, 130, 246, 0.15);
    color: var(--accent-secondary);
  }

  .stat-icon.completed {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success);
  }

  .stat-icon.error {
    background: rgba(239, 68, 68, 0.15);
    color: var(--error);
  }

  .stat-content {
    display: flex;
    flex-direction: column;
  }

  .stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
  }

  .stat-label {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .filters-bar {
    display: flex;
    gap: 16px;
    align-items: flex-end;
    padding: 20px;
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
    min-width: 150px;
  }

  .filter-group label {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .filter-select,
  .filter-input {
    padding: 10px 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.9rem;
  }

  .filter-select:focus,
  .filter-input:focus {
    outline: none;
    border-color: var(--accent-secondary);
  }

  .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .table-actions {
    display: flex;
    gap: 12px;
  }

  .btn-sm {
    padding: 8px 16px;
    font-size: 0.85rem;
  }

  .table-container {
    min-height: 400px;
    position: relative;
  }

  .loading-state,
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-subtle);
    border-top-color: var(--accent-secondary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .empty-state svg {
    margin-bottom: 16px;
    color: var(--text-muted);
  }

  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-scraped { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
  .status-pending_review { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
  .status-ready_for_ai { background: rgba(59, 130, 246, 0.15); color: var(--accent-secondary); }
  .status-processing_ai { background: rgba(14, 165, 233, 0.15); color: #0ea5e9; }
  .status-ai_completed { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
  .status-ready_to_publish { background: rgba(16, 185, 129, 0.15); color: var(--success); }
  .status-published { background: rgba(16, 185, 129, 0.15); color: var(--success); }
  .status-discarded { background: rgba(107, 114, 128, 0.15); color: #6b7280; }
  .status-error { background: rgba(239, 68, 68, 0.15); color: var(--error); }
  .status-duplicate { background: rgba(107, 114, 128, 0.15); color: #6b7280; }

  .media-badge {
    display: inline-block;
    padding: 4px 8px;
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .item-title {
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .item-section {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .item-date {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .action-buttons {
    display: flex;
    gap: 8px;
  }

  .btn-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    padding: 0;
    border: 1px solid var(--border-subtle);
    background: transparent;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-icon:hover {
    background: var(--bg-card-hover);
    border-color: var(--border-medium);
    color: var(--text-primary);
  }

  /* Success button - green */
  .btn-icon.btn-success {
    color: var(--success);
    border-color: rgba(16, 185, 129, 0.3);
  }

  .btn-icon.btn-success:hover {
    background: rgba(16, 185, 129, 0.1);
    border-color: var(--success);
  }

  /* Warning button - orange */
  .btn-icon.btn-warning {
    color: var(--warning);
    border-color: rgba(245, 158, 11, 0.3);
  }

  .btn-icon.btn-warning:hover {
    background: rgba(245, 158, 11, 0.1);
    border-color: var(--warning);
  }

  /* Danger button - red */
  .btn-icon.btn-danger {
    color: var(--error);
    border-color: rgba(239, 68, 68, 0.3);
  }

  .btn-icon.btn-danger:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: var(--error);
  }

  .pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-subtle);
    margin-top: 20px;
  }

  .pagination-info {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  /* Modal */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
  }

  .modal-content {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid var(--border-subtle);
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
  }

  .modal-close:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
  }

  .modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
  }

  .modal-footer {
    padding: 20px 24px;
    border-top: 1px solid var(--border-subtle);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }

  .item-details {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .detail-section {
    padding: 20px;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
  }

  .detail-section h3 {
    margin: 0 0 16px 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 12px;
    font-size: 0.9rem;
  }

  .detail-grid div {
    color: var(--text-secondary);
  }

  .detail-grid strong {
    color: var(--text-primary);
    font-weight: 500;
  }

  .detail-field {
    margin-bottom: 16px;
  }

  .detail-field:last-child {
    margin-bottom: 0;
  }

  .detail-field strong {
    display: block;
    margin-bottom: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .detail-field p {
    margin: 0;
    color: var(--text-secondary);
    line-height: 1.6;
  }

  .detail-field a {
    color: var(--accent-secondary);
    text-decoration: none;
    word-break: break-all;
  }

  .detail-field a:hover {
    text-decoration: underline;
  }

  .content-preview {
    padding: 12px;
    background: var(--bg-primary);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text-secondary);
    white-space: pre-wrap;
  }

  .tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .tag {
    display: inline-block;
    padding: 4px 10px;
    background: var(--bg-primary);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .error-section {
    background: rgba(239, 68, 68, 0.05);
    border: 1px solid rgba(239, 68, 68, 0.2);
  }

  .error-message {
    margin: 0;
    padding: 12px;
    background: var(--bg-primary);
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    line-height: 1.6;
    color: var(--error);
    overflow-x: auto;
  }

  /* Publish button - indigo */
  .btn-icon.btn-publish {
    color: #6366f1;
    border-color: rgba(99, 102, 241, 0.3);
  }

  .btn-icon.btn-publish:hover {
    background: rgba(99, 102, 241, 0.1);
    border-color: #6366f1;
  }

  /* Alert info */
  .alert-info {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 16px;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: var(--radius-sm);
    color: var(--accent-secondary);
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 16px;
  }

  .alert-info svg {
    flex-shrink: 0;
    margin-top: 2px;
  }

  .alert-info p {
    margin: 0;
  }

  /* Modal large variant */
  .modal-large {
    max-width: 900px;
  }

  @media (max-width: 768px) {
    .filters-bar {
      flex-direction: column;
      align-items: stretch;
    }

    .filter-group {
      min-width: 100%;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .table {
      font-size: 0.85rem;
    }

    .modal-content {
      max-height: 100vh;
      border-radius: 0;
    }
  }
</style>
