---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Feeds RSS - Admin">
  <div class="page-header">
    <div>
      <h1 class="page-title">Feeds RSS</h1>
      <p class="page-subtitle">Gestiona las fuentes de noticias automaticas</p>
    </div>
    <button class="btn btn-primary" id="add-feed-btn">+ Agregar Feed</button>
  </div>

  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>URL</th>
          <th>Estado</th>
          <th>Ultimo fetch</th>
          <th>Intervalo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="feeds-tbody">
        <tr>
          <td colspan="6" class="loading-cell">Cargando...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-title">Agregar Feed</h3>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <form id="feed-form">
        <input type="hidden" id="feed-id" />
        <div class="form-group">
          <label class="form-label" for="feed-name">Nombre</label>
          <input type="text" id="feed-name" class="form-input" required placeholder="Ej: BBC News" />
        </div>
        <div class="form-group">
          <label class="form-label" for="feed-url">URL del Feed</label>
          <input type="url" id="feed-url" class="form-input" required placeholder="https://ejemplo.com/rss" />
        </div>
        <div class="form-group">
          <label class="form-label" for="feed-interval">Intervalo (minutos)</label>
          <input type="number" id="feed-interval" class="form-input" min="5" max="1440" value="60" />
        </div>
        <div class="form-group" id="active-group" style="display: none;">
          <label class="checkbox-label">
            <input type="checkbox" id="feed-active" checked />
            Feed activo
          </label>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancel-btn">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="submit-btn">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<script>
  import { authFetch } from '../../../lib/auth';

  let feeds: any[] = [];
  let editingId: string | null = null;

  async function loadFeeds() {
    const tbody = document.getElementById('feeds-tbody')!;
    tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">Cargando...</td></tr>';

    try {
      const r = await authFetch('/api/feeds');
      if (!r.ok) throw new Error('Failed to load');

      feeds = await r.json();

      if (feeds.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">No hay feeds configurados</td></tr>';
        return;
      }

      tbody.innerHTML = feeds.map(f => `
        <tr data-id="${f.id}">
          <td><strong>${f.name}</strong></td>
          <td class="url-cell" title="${f.url}">${truncateUrl(f.url)}</td>
          <td>
            ${f.is_active
              ? '<span class="badge badge-success">Activo</span>'
              : '<span class="badge badge-error">Inactivo</span>'}
            ${f.error_count > 0
              ? `<span class="badge badge-warning">${f.error_count} errores</span>`
              : ''}
          </td>
          <td>${f.last_fetched_at ? formatDate(f.last_fetched_at) : 'Nunca'}</td>
          <td>${f.fetch_interval_minutes} min</td>
          <td class="actions-cell">
            <button class="btn btn-small btn-secondary fetch-btn" data-id="${f.id}">Fetch</button>
            <button class="btn btn-small btn-secondary edit-btn" data-id="${f.id}">Editar</button>
            <button class="btn btn-small btn-danger delete-btn" data-id="${f.id}">Eliminar</button>
          </td>
        </tr>
        ${f.last_error ? `
          <tr class="error-row">
            <td colspan="6" class="error-detail">
              <strong>Ultimo error:</strong> ${f.last_error}
            </td>
          </tr>
        ` : ''}
      `).join('');

      setupButtons();
    } catch (e) {
      console.error('Error:', e);
      tbody.innerHTML = '<tr><td colspan="6" class="error-cell">Error al cargar</td></tr>';
    }
  }

  function truncateUrl(url: string): string {
    if (url.length > 50) {
      return url.substring(0, 50) + '...';
    }
    return url;
  }

  function formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    return date.toLocaleString('es-AR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function setupButtons() {
    document.querySelectorAll('.fetch-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        await triggerFetch(id!);
      });
    });

    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        openEditModal(id!);
      });
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        if (confirm('Â¿Eliminar este feed?')) {
          await deleteFeed(id!);
        }
      });
    });
  }

  async function triggerFetch(id: string) {
    try {
      const r = await authFetch(`/api/feeds/${id}/fetch`, { method: 'POST' });
      if (r.ok) {
        alert('Fetch programado');
        loadFeeds();
      }
    } catch (e) {
      console.error('Error:', e);
    }
  }

  async function deleteFeed(id: string) {
    try {
      const r = await authFetch(`/api/feeds/${id}`, { method: 'DELETE' });
      if (r.ok) {
        loadFeeds();
      }
    } catch (e) {
      console.error('Error:', e);
    }
  }

  // Modal functions
  function openModal() {
    document.getElementById('modal-overlay')!.style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('modal-overlay')!.style.display = 'none';
    editingId = null;
    (document.getElementById('feed-form') as HTMLFormElement).reset();
    document.getElementById('active-group')!.style.display = 'none';
  }

  function openAddModal() {
    editingId = null;
    document.getElementById('modal-title')!.textContent = 'Agregar Feed';
    document.getElementById('active-group')!.style.display = 'none';
    (document.getElementById('feed-id') as HTMLInputElement).value = '';
    (document.getElementById('feed-form') as HTMLFormElement).reset();
    openModal();
  }

  function openEditModal(id: string) {
    const feed = feeds.find(f => f.id === id);
    if (!feed) return;

    editingId = id;
    document.getElementById('modal-title')!.textContent = 'Editar Feed';
    document.getElementById('active-group')!.style.display = 'block';
    (document.getElementById('feed-id') as HTMLInputElement).value = id;
    (document.getElementById('feed-name') as HTMLInputElement).value = feed.name;
    (document.getElementById('feed-url') as HTMLInputElement).value = feed.url;
    (document.getElementById('feed-interval') as HTMLInputElement).value = feed.fetch_interval_minutes;
    (document.getElementById('feed-active') as HTMLInputElement).checked = feed.is_active;
    openModal();
  }

  // Event listeners
  document.getElementById('add-feed-btn')?.addEventListener('click', openAddModal);
  document.getElementById('modal-close')?.addEventListener('click', closeModal);
  document.getElementById('cancel-btn')?.addEventListener('click', closeModal);
  document.getElementById('modal-overlay')?.addEventListener('click', (e) => {
    if (e.target === document.getElementById('modal-overlay')) {
      closeModal();
    }
  });

  document.getElementById('feed-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = (document.getElementById('feed-name') as HTMLInputElement).value;
    const url = (document.getElementById('feed-url') as HTMLInputElement).value;
    const interval = parseInt((document.getElementById('feed-interval') as HTMLInputElement).value);
    const isActive = (document.getElementById('feed-active') as HTMLInputElement).checked;

    try {
      let r;
      if (editingId) {
        r = await authFetch(`/api/feeds/${editingId}`, {
          method: 'PUT',
          body: JSON.stringify({ name, url, fetch_interval_minutes: interval, is_active: isActive }),
        });
      } else {
        r = await authFetch('/api/feeds', {
          method: 'POST',
          body: JSON.stringify({ name, url, fetch_interval_minutes: interval }),
        });
      }

      if (r.ok) {
        closeModal();
        loadFeeds();
      } else {
        const data = await r.json().catch(() => ({}));
        alert(data.detail || 'Error al guardar');
      }
    } catch (e) {
      console.error('Error:', e);
      alert('Error al guardar');
    }
  });

  // Initial load
  document.addEventListener('DOMContentLoaded', loadFeeds);
</script>

<style>
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
  }

  .url-cell {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .actions-cell {
    display: flex;
    gap: 8px;
  }

  .btn-small {
    padding: 6px 12px;
    font-size: 0.8rem;
  }

  .loading-cell,
  .empty-cell,
  .error-cell {
    text-align: center;
    padding: 40px !important;
    color: var(--text-muted);
  }

  .error-row td {
    background: rgba(239, 68, 68, 0.05) !important;
  }

  .error-detail {
    font-size: 0.85rem;
    color: var(--error);
    padding: 8px 16px !important;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    width: 100%;
    max-width: 500px;
    margin: 20px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-subtle);
  }

  .modal-header h3 {
    font-size: 1.1rem;
    font-weight: 600;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0;
    line-height: 1;
  }

  .modal-close:hover {
    color: var(--text-primary);
  }

  .modal form {
    padding: 24px;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }

  .checkbox-label input {
    width: 18px;
    height: 18px;
  }

  .form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border-subtle);
  }
</style>
