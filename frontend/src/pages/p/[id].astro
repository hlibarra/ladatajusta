---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';

type Agent = {
	id: string;
	name: string;
	slug: string;
	description: string;
	specialization?: string | null;
	avatar_url?: string | null;
};

type MediaItem = {
	type: 'image' | 'video';
	url: string;
	caption?: string | null;
	order: number;
};

type Publication = {
	id: string;
	state: string;
	title: string;
	summary: string;
	body: string;
	category?: string | null;
	tags: string[];
	created_at: string;
	published_at?: string | null;
	agent?: Agent | null;
	content_sin_vueltas?: string | null;
	content_lo_central?: string | null;
	content_en_profundidad?: string | null;
	media?: MediaItem[];
	pulso_informativo?: number | null;
	origin_type?: string | null;
};

interface DisplayConfig {
	show_images: boolean;
	card_style: string;
	show_author: boolean;
	show_reading_time: boolean;
	show_source_media: boolean;
}

const { id } = Astro.params;
const API_BASE = import.meta.env.PUBLIC_API_BASE_URL ?? 'http://localhost:8000';
const CLIENT_API_BASE = import.meta.env.PUBLIC_CLIENT_API_BASE_URL ?? import.meta.env.PUBLIC_API_BASE_URL ?? '';

let pub: Publication | null = null;
let error = false;

// Fetch display configuration
let displayConfig: DisplayConfig = {
	show_images: true,
	card_style: 'default',
	show_author: true,
	show_reading_time: true,
	show_source_media: true
};

try {
	const configRes = await fetch(`${API_BASE}/api/config/display`);
	if (configRes.ok) {
		displayConfig = await configRes.json();
	}
} catch (e) {
	// Use defaults if config fetch fails
}

const showImages = displayConfig.show_images;

try {
	const res = await fetch(`${API_BASE}/api/publications/${id}`);
	if (res.ok) {
		pub = await res.json();
	} else {
		error = true;
	}
} catch (e) {
	error = true;
}

// Helper para tiempo relativo
function getTimeAgo(dateString: string): string {
	const date = new Date(dateString);
	const now = new Date();
	const diffMs = now.getTime() - date.getTime();
	const diffMins = Math.floor(diffMs / 60000);
	const diffHours = Math.floor(diffMins / 60);
	const diffDays = Math.floor(diffHours / 24);

	if (diffMins < 60) return `hace ${diffMins} min`;
	if (diffHours < 24) return `hace ${diffHours}h`;
	if (diffDays === 1) return 'ayer';
	if (diffDays < 7) return `hace ${diffDays} d铆as`;
	return date.toLocaleDateString('es-AR', { day: 'numeric', month: 'long', year: 'numeric' });
}

// Mapeo de pulso informativo a estado editorial
function getEditorialState(pulso: number | null | undefined): string | null {
	if (!pulso) return null;
	const states: Record<number, string> = {
		1: 'estabilidad',
		2: 'incertidumbre',
		3: 'tensi贸n',
		4: 'impacto',
		5: 'cierre'
	};
	return states[pulso] || null;
}

// Mapeo de origin_type a texto legible
function getOriginLabel(originType: string | null | undefined): string | null {
	if (!originType) return null;
	const labels: Record<string, string> = {
		'detected_media': 'Detectado en medios',
		'editorial_ia': 'Editorial IA'
	};
	return labels[originType] || null;
}
---

<Layout title={pub?.title ?? 'Noticia'}>
	{error || !pub ? (
		<div class="error-state">
			<p>No se pudo cargar la noticia.</p>
			<a href="/" class="back-link">Volver al inicio</a>
		</div>
	) : (
		<article class="article">
			<header class="article-header">
				<div class="article-meta">
					{pub.category && (
						<span class="category">{pub.category}</span>
					)}
					{getEditorialState(pub.pulso_informativo) && (
						<span class="editorial-state">{getEditorialState(pub.pulso_informativo)}</span>
					)}
					<time class="time">{getTimeAgo(pub.published_at || pub.created_at)}</time>
				</div>
				<h1 class="title">{pub.title}</h1>
				{pub.agent && (
					<div class="byline">
						Por <span class="agent-name">{pub.agent.name}</span>
						{pub.agent.specialization && (
							<span class="agent-spec"> 路 {pub.agent.specialization}</span>
						)}
					</div>
				)}
				{getOriginLabel(pub.origin_type) && (
					<div class="origin-badge">
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
							<path d="M12 2L2 7l10 5 10-5-10-5z"/>
							<path d="M2 17l10 5 10-5"/>
							<path d="M2 12l10 5 10-5"/>
						</svg>
						{getOriginLabel(pub.origin_type)}
					</div>
				)}
			</header>

			{/* Media Gallery - Only show if images are enabled */}
			{showImages && pub.media && pub.media.length > 0 && (
				<div class="media-gallery">
					{pub.media.sort((a, b) => a.order - b.order).map((item) => (
						<figure class="media-item">
							{item.type === 'image' ? (
								<img src={item.url} alt={item.caption || pub.title} loading="lazy" />
							) : (
								<div class="video-wrapper">
									<iframe
										src={item.url}
										title={item.caption || pub.title}
										frameborder="0"
										allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
										allowfullscreen
									></iframe>
								</div>
							)}
							{item.caption && <figcaption>{item.caption}</figcaption>}
						</figure>
					))}
				</div>
			)}

			{/* Esto es lo importante - Destacado */}
			{pub.content_sin_vueltas && (
				<section class="highlight-box">
					<div class="highlight-header">
						<svg class="highlight-icon" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
							<circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.15"/>
							<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
							<path d="M12 16v-4M12 8h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
						</svg>
						<span class="highlight-label">Esto es lo importante</span>
					</div>
					<div class="highlight-content">
						{pub.content_sin_vueltas.split('\n').map((paragraph) => (
							paragraph.trim() && <p>{paragraph}</p>
						))}
					</div>
				</section>
			)}

			{/* Lo central */}
			{pub.content_lo_central && (
				<section class="content-section">
					<h2 class="section-label">Lo central</h2>
					<div class="content-body">
						{pub.content_lo_central.split('\n').map((paragraph) => (
							paragraph.trim() && <p>{paragraph}</p>
						))}
					</div>
				</section>
			)}

			{/* AdSense: Rectangle Ad (300x250) */}
			{pub.content_lo_central && (
				<div class="ad-rectangle">
					<ins class="adsbygoogle"
						style="display:block"
						data-ad-client="ca-pub-XXXXXXXXXX"
						data-ad-slot="XXXXXXXXXX"
						data-ad-format="rectangle"
						data-full-width-responsive="true"></ins>
					<script is:inline>(adsbygoogle = window.adsbygoogle || []).push({});</script>
				</div>
			)}

			{/* En profundidad */}
			{pub.content_en_profundidad && (
				<section class="content-section depth">
					<h2 class="section-label">En profundidad</h2>
					<div class="content-body">
						{pub.content_en_profundidad.split('\n').map((paragraph) => (
							paragraph.trim() && <p>{paragraph}</p>
						))}
					</div>
				</section>
			)}

			{pub.tags?.length > 0 && (
				<div class="tags">
					{pub.tags.slice(0, 8).map((t) => (
						<span class="tag">{t}</span>
					))}
				</div>
			)}

			<footer class="article-footer">
				<div class="votes" data-id={pub.id} data-api={CLIENT_API_BASE}>
					<span class="votes-label">Esta noticia te pareci贸:</span>
					<div class="vote-buttons">
						<button class="vote-btn hot" data-type="hot">
							<span class="vote-icon"></span>
							Alta data
						</button>
						<button class="vote-btn cold" data-type="cold">
							<span class="vote-icon">锔</span>
							Fr铆a
						</button>
					</div>
					<span class="vote-counts"></span>
				</div>
			</footer>

		</article>
	)}
</Layout>

<script is:inline>
	const votesDiv = document.querySelector('.votes');

	if (votesDiv) {
		const API_BASE = votesDiv.getAttribute('data-api') || '';
		const id = votesDiv.getAttribute('data-id');
		const countsEl = votesDiv.querySelector('.vote-counts');
		const hotBtn = votesDiv.querySelector('button.vote-btn.hot');
		const coldBtn = votesDiv.querySelector('button.vote-btn.cold');

		const storageKey = `vote_${id}`;
		let userVote = localStorage.getItem(storageKey);

		function updateButtonStates(currentVote) {
			hotBtn?.classList.remove('active');
			coldBtn?.classList.remove('active');

			if (currentVote === 'hot') {
				hotBtn?.classList.add('active');
			} else if (currentVote === 'cold') {
				coldBtn?.classList.add('active');
			}
		}

		async function fetchVoteCounts() {
			try {
				const r = await fetch(`${API_BASE}/api/stats/votes/${id}`);
				if (r.ok) {
					const data = await r.json();
					if (countsEl) {
						countsEl.textContent = `${data.hot} 路 ${data.cold}`;
					}
				}
			} catch (e) {
				console.error('Error fetching vote counts:', e);
			}
		}

		updateButtonStates(userVote);
		fetchVoteCounts();

		votesDiv.querySelectorAll('button.vote-btn').forEach((btn) => {
			btn.addEventListener('click', async () => {
				const voteType = btn.getAttribute('data-type');
				if (!voteType || !id) return;

				hotBtn?.setAttribute('disabled', 'true');
				coldBtn?.setAttribute('disabled', 'true');

				try {
					const r = await fetch(`${API_BASE}/api/publications/${id}/vote`, {
						method: 'POST',
						headers: { 'content-type': 'application/json' },
						body: JSON.stringify({ vote_type: voteType }),
					});

					if (!r.ok) throw new Error(String(r.status));

					const data = await r.json();

					if (countsEl) {
						countsEl.textContent = `${data.hot} 路 ${data.cold}`;
					}

					localStorage.setItem(storageKey, voteType);
					userVote = voteType;
					updateButtonStates(userVote);

				} catch (e) {
					console.error('Error voting:', e);
				} finally {
					hotBtn?.removeAttribute('disabled');
					coldBtn?.removeAttribute('disabled');
				}
			});
		});
	}
</script>

<style>
	/* ===== BASE ===== */
	.article {
		max-width: 680px;
		margin: 0 auto;
		padding: 0 20px;
	}

	.error-state {
		text-align: center;
		padding: 80px 20px;
		color: var(--text-muted);
	}

	.error-state .back-link {
		display: inline-block;
		margin-top: 16px;
		color: var(--accent-main);
	}

	/* ===== HEADER ===== */
	.article-header {
		margin-bottom: 48px;
		padding-bottom: 32px;
		border-bottom: 1px solid var(--border-subtle);
		border-left: 3px solid var(--accent-main);
		padding-left: 24px;
		margin-left: -24px;
	}

	.article-meta {
		display: flex;
		align-items: baseline;
		gap: 0;
		margin-bottom: 16px;
		font-size: 0.8rem;
		color: var(--text-muted);
	}

	.category {
		color: var(--accent-muted);
		font-weight: 500;
		text-transform: lowercase;
	}

	.category::after {
		content: '路';
		margin: 0 10px;
		color: var(--text-muted);
		opacity: 0.5;
	}

	.editorial-state {
		color: var(--text-muted);
	}

	.editorial-state::after {
		content: '路';
		margin: 0 10px;
		opacity: 0.5;
	}

	.time {
		color: var(--text-muted);
		opacity: 0.8;
	}

	.title {
		font-size: clamp(1.75rem, 5vw, 2.5rem);
		font-weight: 700;
		line-height: 1.15;
		letter-spacing: -0.025em;
		margin: 0 0 20px;
		color: var(--text-primary);
	}

	.byline {
		font-size: 0.9rem;
		color: var(--text-muted);
	}

	.agent-name {
		color: var(--text-secondary);
		font-weight: 500;
	}

	.agent-spec {
		color: var(--accent-recent);
	}

	.origin-badge {
		display: inline-flex;
		align-items: center;
		gap: 6px;
		margin-top: 12px;
		padding: 6px 12px;
		background: rgba(56, 189, 248, 0.1);
		border: 1px solid rgba(56, 189, 248, 0.25);
		border-radius: 100px;
		font-size: 0.75rem;
		color: #38bdf8;
		font-weight: 500;
	}

	.origin-badge svg {
		color: #38bdf8;
		opacity: 0.8;
	}

	/* ===== MEDIA ===== */
	.media-gallery {
		margin: 0 0 48px;
	}

	.media-item {
		margin: 0;
	}

	.media-item img {
		width: 100%;
		height: auto;
		display: block;
	}

	.video-wrapper {
		position: relative;
		padding-bottom: 56.25%;
		height: 0;
		overflow: hidden;
	}

	.video-wrapper iframe {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
	}

	.media-item figcaption {
		padding: 12px 0;
		font-size: 0.85rem;
		color: var(--text-muted);
		font-style: italic;
		border-bottom: 1px solid var(--border-subtle);
	}

	/* ===== ESTO ES LO IMPORTANTE ===== */
	.highlight-box {
		margin-bottom: 48px;
		padding: 24px 28px;
		background: rgba(99, 102, 241, 0.06);
		border-left: 4px solid var(--accent-main);
		border-radius: 0 12px 12px 0;
	}

	.highlight-header {
		display: flex;
		align-items: center;
		gap: 10px;
		margin-bottom: 16px;
	}

	.highlight-icon {
		color: var(--accent-main);
		flex-shrink: 0;
	}

	.highlight-label {
		font-size: 0.8rem;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.04em;
		color: var(--accent-main);
	}

	.highlight-content {
		font-size: 1.1875rem;
		line-height: 1.6;
		color: var(--text-primary);
		font-weight: 500;
	}

	.highlight-content p {
		margin: 0 0 16px;
	}

	.highlight-content p:last-child {
		margin-bottom: 0;
	}

	/* ===== CONTENIDO ===== */
	.content-section {
		margin-bottom: 48px;
	}

	.section-label {
		font-size: 0.75rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		color: var(--accent-section);
		margin: 0 0 20px;
		padding-bottom: 12px;
		border-bottom: 1px solid var(--border-subtle);
	}

	.depth .section-label {
		color: var(--accent-recent);
	}

	.content-body {
		font-size: 1.0625rem;
		line-height: 1.75;
		color: var(--text-secondary);
	}

	.content-body p {
		margin: 0 0 20px;
	}

	.content-body p:last-child {
		margin-bottom: 0;
	}

	/* ===== TAGS ===== */
	.tags {
		display: flex;
		gap: 8px;
		flex-wrap: wrap;
		margin-bottom: 48px;
		padding-top: 24px;
		border-top: 1px solid var(--border-subtle);
	}

	.tag {
		padding: 4px 12px;
		font-size: 0.8rem;
		color: var(--text-muted);
		background: var(--bg-secondary);
		border-radius: 100px;
	}

	/* ===== FOOTER ===== */
	.article-footer {
		padding: 32px 0;
		border-top: 1px solid var(--border-subtle);
	}

	.votes {
		display: flex;
		flex-direction: column;
		gap: 16px;
	}

	.votes-label {
		font-size: 0.9rem;
		color: var(--text-muted);
	}

	.vote-buttons {
		display: flex;
		gap: 12px;
	}

	.vote-btn {
		display: inline-flex;
		align-items: center;
		gap: 8px;
		padding: 10px 20px;
		background: transparent;
		border: 1px solid var(--border-subtle);
		border-radius: 100px;
		color: var(--text-secondary);
		font-size: 0.9rem;
		cursor: pointer;
		transition: all 0.2s;
	}

	.vote-btn:hover:not(:disabled) {
		border-color: var(--text-muted);
	}

	.vote-btn:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}

	.vote-btn.hot:hover:not(:disabled),
	.vote-btn.hot.active {
		border-color: var(--accent-section);
		color: var(--accent-section);
		background: rgba(245, 158, 11, 0.1);
	}

	.vote-btn.cold:hover:not(:disabled),
	.vote-btn.cold.active {
		border-color: var(--accent-main);
		color: var(--accent-main);
		background: rgba(99, 102, 241, 0.1);
	}

	.vote-icon {
		font-size: 1rem;
	}

	.vote-counts {
		font-size: 0.85rem;
		color: var(--text-muted);
	}

	/* ===== AVISO ===== */
	.site-notice {
		padding: 32px 0 48px;
		border-top: 1px solid var(--border-subtle);
		margin-top: 32px;
	}

	.site-notice p {
		font-size: 0.8rem;
		line-height: 1.6;
		color: var(--text-muted);
		margin: 0;
		max-width: 480px;
		opacity: 0.7;
	}

	/* ===== COLORES ===== */
	:root {
		--accent-muted: #6b7280;
		--accent-main: #6366f1;
		--accent-recent: #10b981;
		--accent-section: #f59e0b;
	}

	@media (prefers-color-scheme: dark) {
		:root {
			--accent-muted: #9ca3af;
			--accent-main: #818cf8;
			--accent-recent: #34d399;
			--accent-section: #fbbf24;
		}

		.highlight-box {
			background: rgba(129, 140, 248, 0.1);
		}
	}

	/* ===== RESPONSIVE ===== */
	@media (max-width: 640px) {
		.article {
			padding: 0 16px;
		}

		.article-header {
			margin-bottom: 32px;
			padding-bottom: 24px;
			padding-left: 16px;
			margin-left: -16px;
		}

		.title {
			font-size: 1.5rem;
		}

		.highlight-box {
			padding: 20px;
			margin-bottom: 36px;
			margin-left: -16px;
			margin-right: -16px;
			border-radius: 0;
		}

		.highlight-content {
			font-size: 1.0625rem;
		}

		.content-section {
			margin-bottom: 36px;
		}

		.content-body {
			font-size: 1rem;
		}

		.content-body.lead {
			font-size: 1.0625rem;
		}

		.tags {
			margin-bottom: 32px;
			padding-top: 20px;
		}

		.vote-buttons {
			flex-direction: column;
		}

		.vote-btn {
			justify-content: center;
		}

		.site-notice {
			padding: 24px 0 40px;
			margin-top: 24px;
		}

		.site-notice p {
			font-size: 0.75rem;
		}
	}

	/* ===== ADSENSE RECTANGLE ===== */
	.ad-rectangle {
		padding: 16px;
		margin: 32px 0;
		background: var(--bg-card);
		border: 1px solid var(--border-subtle);
		border-radius: 8px;
		text-align: center;
	}
	.ad-rectangle::before {
		content: 'PUBLICIDAD';
		display: block;
		font-size: 0.65rem;
		color: var(--text-muted);
		letter-spacing: 1px;
		margin-bottom: 8px;
	}
</style>
