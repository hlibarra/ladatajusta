---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';

type Agent = {
	id: string;
	name: string;
	slug: string;
	description: string;
	specialization?: string | null;
	avatar_url?: string | null;
};

type Publication = {
	id: string;
	state: string;
	title: string;
	summary: string;
	body: string;
	category?: string | null;
	tags: string[];
	created_at: string;
	published_at?: string | null;
	agent?: Agent | null;
};

const { id } = Astro.params;
const API_BASE = import.meta.env.PUBLIC_API_BASE_URL ?? 'http://localhost:8000';

let pub: Publication | null = null;
let error = false;

try {
	const res = await fetch(`${API_BASE}/api/publications/${id}`);
	if (res.ok) {
		pub = await res.json();
	} else {
		error = true;
	}
} catch (e) {
	error = true;
}
---

<Layout title={pub?.title ?? 'Noticia'}>
	<nav class="breadcrumb">
		<a href="/">Inicio</a>
		<span class="sep">/</span>
		<span>Noticia</span>
	</nav>

	{error || !pub ? (
		<div class="error-card">
			<p>No se pudo cargar la noticia.</p>
			<a href="/" class="back-btn">Volver al inicio</a>
		</div>
	) : (
		<article class="article">
			<header class="article-header">
				{pub.category && <span class="category">{pub.category}</span>}
				<time class="date">{new Date(pub.created_at).toLocaleDateString('es-AR', { day: 'numeric', month: 'long', year: 'numeric' })}</time>
			</header>

			<h1 class="title">{pub.title}</h1>

			{pub.agent && (
				<div class="agent-byline">
					<div class="agent-avatar">
						{pub.agent.avatar_url ? (
							<img src={pub.agent.avatar_url} alt={pub.agent.name} />
						) : (
							<div class="agent-avatar-placeholder">
								{pub.agent.name.charAt(0)}
							</div>
						)}
					</div>
					<div class="agent-info">
						<div class="agent-label">Escrito por</div>
						<div class="agent-name">{pub.agent.name}</div>
						{pub.agent.specialization && (
							<div class="agent-specialization">{pub.agent.specialization}</div>
						)}
					</div>
				</div>
			)}

			<p class="summary">{pub.summary}</p>

			{pub.tags?.length > 0 && (
				<div class="tags">
					{pub.tags.slice(0, 10).map((t) => (
						<span class="tag">{t}</span>
					))}
				</div>
			)}

			<div class="body-content">
				{pub.body.split('\n').map((paragraph) => (
					paragraph.trim() && <p>{paragraph}</p>
				))}
			</div>

			<footer class="article-footer">
				<div class="votes" data-id={pub.id}>
					<span class="votes-label">Esta noticia te parecio:</span>
					<button class="vote-btn hot" data-type="hot">Alta Data</button>
					<button class="vote-btn cold" data-type="cold">Fria</button>
					<span class="vote-counts"></span>
				</div>
				<a href="/" class="back-link">Ver mas noticias</a>
			</footer>
		</article>
	)}
</Layout>

<script>
	const API_BASE = import.meta.env.PUBLIC_API_BASE_URL ?? 'http://localhost:8000';
	const votesDiv = document.querySelector('.votes');

	if (votesDiv) {
		const id = votesDiv.getAttribute('data-id');
		const countsEl = votesDiv.querySelector('.vote-counts');
		const hotBtn = votesDiv.querySelector('button.vote-btn.hot');
		const coldBtn = votesDiv.querySelector('button.vote-btn.cold');

		// Load initial counts and user vote from localStorage
		const storageKey = `vote_${id}`;
		let userVote = localStorage.getItem(storageKey);

		// Function to update button states
		function updateButtonStates(currentVote: string | null) {
			hotBtn?.classList.remove('active');
			coldBtn?.classList.remove('active');

			if (currentVote === 'hot') {
				hotBtn?.classList.add('active');
			} else if (currentVote === 'cold') {
				coldBtn?.classList.add('active');
			}
		}

		// Function to fetch and display vote counts
		async function fetchVoteCounts() {
			try {
				const r = await fetch(`${API_BASE}/api/stats/votes/${id}`);
				if (r.ok) {
					const data = await r.json();
					if (countsEl) {
						countsEl.textContent = `üî• ${data.hot} ¬∑ ‚ùÑÔ∏è ${data.cold}`;
					}
				}
			} catch (e) {
				console.error('Error fetching vote counts:', e);
			}
		}

		// Initialize
		updateButtonStates(userVote);
		fetchVoteCounts();

		// Add click handlers
		votesDiv.querySelectorAll('button.vote-btn').forEach((btn) => {
			btn.addEventListener('click', async () => {
				const voteType = btn.getAttribute('data-type');
				if (!voteType || !id) return;

				// Disable buttons while voting
				hotBtn?.setAttribute('disabled', 'true');
				coldBtn?.setAttribute('disabled', 'true');

				try {
					const r = await fetch(`${API_BASE}/api/publications/${id}/vote`, {
						method: 'POST',
						headers: { 'content-type': 'application/json' },
						body: JSON.stringify({ vote_type: voteType }),
					});

					if (!r.ok) throw new Error(String(r.status));

					const data = await r.json();

					// Update counts
					if (countsEl) {
						countsEl.textContent = `üî• ${data.hot} ¬∑ ‚ùÑÔ∏è ${data.cold}`;
					}

					// Save vote to localStorage
					localStorage.setItem(storageKey, voteType);
					userVote = voteType;

					// Update button states
					updateButtonStates(userVote);

				} catch (e) {
					console.error('Error voting:', e);
					if (countsEl) {
						countsEl.textContent = 'Error al votar';
					}
				} finally {
					// Re-enable buttons
					hotBtn?.removeAttribute('disabled');
					coldBtn?.removeAttribute('disabled');
				}
			});
		});
	}
</script>

<style>
	.breadcrumb { display: flex; align-items: center; gap: 8px; margin-bottom: 24px; font-size: 0.9rem; }
	.breadcrumb a { color: var(--text-secondary); }
	.breadcrumb a:hover { color: var(--accent-secondary); }
	.breadcrumb .sep { color: var(--text-muted); }
	.breadcrumb span:last-child { color: var(--text-muted); }

	.error-card { padding: 48px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); text-align: center; }
	.error-card p { margin: 0 0 16px; color: var(--text-secondary); }
	.back-btn { display: inline-block; padding: 10px 20px; background: var(--accent-primary); color: white; border-radius: var(--radius-md); font-weight: 500; }
	.back-btn:hover { background: var(--accent-secondary); color: white; }

	.article { max-width: 800px; }

	.article-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
	.category { padding: 6px 14px; background: rgba(59, 130, 246, 0.15); border-radius: var(--radius-sm); font-size: 0.85rem; color: var(--accent-secondary); font-weight: 500; }
	.date { font-size: 0.9rem; color: var(--text-muted); }

	.title { margin: 0 0 20px; font-size: 2.5rem; font-weight: 800; letter-spacing: -0.5px; line-height: 1.2; }

	.agent-byline {
		display: flex;
		align-items: center;
		gap: 16px;
		margin: 0 0 24px;
		padding: 16px;
		background: var(--bg-card);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-md);
	}
	.agent-avatar {
		flex-shrink: 0;
		width: 56px;
		height: 56px;
		border-radius: 50%;
		overflow: hidden;
		background: var(--bg-secondary);
		border: 2px solid var(--border-subtle);
	}
	.agent-avatar img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}
	.agent-avatar-placeholder {
		width: 100%;
		height: 100%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.5rem;
		font-weight: 700;
		color: var(--accent-primary);
		background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
	}
	.agent-info {
		flex: 1;
		display: flex;
		flex-direction: column;
		gap: 2px;
	}
	.agent-label {
		font-size: 0.75rem;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		color: var(--text-muted);
		font-weight: 600;
	}
	.agent-name {
		font-size: 1.1rem;
		font-weight: 700;
		color: var(--text-primary);
	}
	.agent-specialization {
		font-size: 0.9rem;
		color: var(--accent-secondary);
		font-weight: 500;
	}

	.summary { margin: 0 0 24px; font-size: 1.2rem; color: var(--text-secondary); line-height: 1.6; padding: 20px; background: var(--bg-card); border-left: 4px solid var(--accent-primary); border-radius: 0 var(--radius-md) var(--radius-md) 0; }

	.tags { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 32px; }
	.tag { padding: 6px 14px; background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); font-size: 0.85rem; color: var(--text-secondary); }

	.body-content { margin-bottom: 40px; }
	.body-content p { margin: 0 0 16px; line-height: 1.8; color: var(--text-primary); font-size: 1.05rem; }

	.article-footer { padding-top: 32px; border-top: 1px solid var(--border-subtle); display: flex; flex-direction: column; gap: 24px; }

	.votes { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
	.votes-label { color: var(--text-secondary); font-size: 0.95rem; }
	.vote-btn {
		padding: 10px 20px;
		background: var(--bg-card);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-md);
		color: var(--text-secondary);
		cursor: pointer;
		font-size: 0.9rem;
		font-weight: 500;
		transition: all 0.2s;
		position: relative;
	}
	.vote-btn:hover:not(:disabled) {
		background: var(--bg-card-hover);
		transform: translateY(-1px);
	}
	.vote-btn:disabled {
		opacity: 0.6;
		cursor: not-allowed;
	}
	.vote-btn.hot:hover:not(:disabled) {
		border-color: #f59e0b;
		color: #f59e0b;
	}
	.vote-btn.hot.active {
		background: rgba(245, 158, 11, 0.15);
		border-color: #f59e0b;
		color: #f59e0b;
		font-weight: 600;
	}
	.vote-btn.cold:hover:not(:disabled) {
		border-color: #3b82f6;
		color: #3b82f6;
	}
	.vote-btn.cold.active {
		background: rgba(59, 130, 246, 0.15);
		border-color: #3b82f6;
		color: #3b82f6;
		font-weight: 600;
	}
	.vote-counts {
		color: var(--text-muted);
		font-size: 0.9rem;
		font-weight: 500;
	}

	.back-link { color: var(--accent-secondary); font-weight: 500; }

	@media (max-width: 768px) {
		.title { font-size: 1.75rem; }
		.summary { font-size: 1.05rem; padding: 16px; }
	}
</style>
