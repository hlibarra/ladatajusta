---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';

type Agent = {
	id: string;
	name: string;
	slug: string;
	description: string;
	specialization?: string | null;
	avatar_url?: string | null;
};

type MediaItem = {
	type: 'image' | 'video';
	url: string;
	caption?: string | null;
	order: number;
};

type Publication = {
	id: string;
	state: string;
	title: string;
	summary: string;
	body: string;
	category?: string | null;
	tags: string[];
	created_at: string;
	published_at?: string | null;
	agent?: Agent | null;
	content_sin_vueltas?: string | null;
	content_lo_central?: string | null;
	content_en_profundidad?: string | null;
	media?: MediaItem[];
};

const { id } = Astro.params;
const API_BASE = import.meta.env.PUBLIC_API_BASE_URL ?? 'http://localhost:8000';

let pub: Publication | null = null;
let error = false;

try {
	const res = await fetch(`${API_BASE}/api/publications/${id}`);
	if (res.ok) {
		pub = await res.json();
	} else {
		error = true;
	}
} catch (e) {
	error = true;
}
---

<Layout title={pub?.title ?? 'Noticia'}>
	<nav class="breadcrumb">
		<a href="/">Inicio</a>
		<span class="sep">/</span>
		<span>Noticia</span>
	</nav>

	{error || !pub ? (
		<div class="error-card">
			<p>No se pudo cargar la noticia.</p>
			<a href="/" class="back-btn">Volver al inicio</a>
		</div>
	) : (
		<article class="article">
			<header class="article-header">
				{pub.category && <span class="category">{pub.category}</span>}
				<time class="date">{new Date(pub.created_at).toLocaleDateString('es-AR', { day: 'numeric', month: 'long', year: 'numeric' })}</time>
			</header>

			<h1 class="title">{pub.title}</h1>

			{pub.agent && (
				<div class="agent-byline">
					<div class="agent-avatar">
						{pub.agent.avatar_url ? (
							<img src={pub.agent.avatar_url} alt={pub.agent.name} />
						) : (
							<div class="agent-avatar-placeholder">
								{pub.agent.name.charAt(0)}
							</div>
						)}
					</div>
					<div class="agent-info">
						<div class="agent-label">Escrito por</div>
						<div class="agent-name">{pub.agent.name}</div>
						{pub.agent.specialization && (
							<div class="agent-specialization">{pub.agent.specialization}</div>
						)}
					</div>
				</div>
			)}

			<p class="summary">{pub.summary}</p>

			{pub.tags?.length > 0 && (
				<div class="tags">
					{pub.tags.slice(0, 10).map((t) => (
						<span class="tag">{t}</span>
					))}
				</div>
			)}

			{/* Media Gallery */}
			{pub.media && pub.media.length > 0 && (
				<div class="media-gallery">
					{pub.media.sort((a, b) => a.order - b.order).map((item) => (
						<div class="media-item">
							{item.type === 'image' ? (
								<img src={item.url} alt={item.caption || pub.title} loading="lazy" />
							) : (
								<div class="video-wrapper">
									<iframe
										src={item.url}
										title={item.caption || pub.title}
										frameborder="0"
										allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
										allowfullscreen
									></iframe>
								</div>
							)}
							{item.caption && <div class="media-caption">{item.caption}</div>}
						</div>
					))}
				</div>
			)}

			{/* Reading Level Selector */}
			{(pub.content_sin_vueltas || pub.content_lo_central || pub.content_en_profundidad) && (
				<div class="reading-level-selector">
					<div class="level-label">Nivel de lectura:</div>
					<div class="level-buttons">
						{pub.content_sin_vueltas && (
							<button class="level-btn" data-level="sin_vueltas">
								<span class="level-name">Sin vueltas</span>
								<span class="level-desc">Directo</span>
							</button>
						)}
						{pub.content_lo_central && (
							<button class="level-btn active" data-level="lo_central">
								<span class="level-name">Lo central</span>
								<span class="level-desc">Esencial</span>
							</button>
						)}
						{pub.content_en_profundidad && (
							<button class="level-btn" data-level="en_profundidad">
								<span class="level-name">En profundidad</span>
								<span class="level-desc">Completo</span>
							</button>
						)}
					</div>
				</div>
			)}

			{/* Hidden JSON data for reading levels */}
			<script type="application/json" id="reading-levels-data" set:html={JSON.stringify({
				sin_vueltas: pub.content_sin_vueltas || '',
				lo_central: pub.content_lo_central || pub.summary,
				en_profundidad: pub.content_en_profundidad || pub.body
			})} />

			<div class="body-content" id="article-content">
				{pub.body.split('\n').map((paragraph) => (
					paragraph.trim() && <p>{paragraph}</p>
				))}
			</div>

			<footer class="article-footer">
				<div class="votes" data-id={pub.id}>
					<span class="votes-label">Esta noticia te parecio:</span>
					<button class="vote-btn hot" data-type="hot">Alta Data</button>
					<button class="vote-btn cold" data-type="cold">Fria</button>
					<span class="vote-counts"></span>
				</div>
				<a href="/" class="back-link">Ver mas noticias</a>
			</footer>
		</article>
	)}
</Layout>

<script is:inline>
	const API_BASE = 'http://localhost:8000';

	// Reading Level Selector Logic
	const levelButtons = document.querySelectorAll('.level-btn');
	const contentDiv = document.getElementById('article-content');

	if (levelButtons.length > 0 && contentDiv) {
		// Get content from JSON script tag
		const dataScript = document.getElementById('reading-levels-data');
		const contentData = dataScript ? JSON.parse(dataScript.textContent) : {
			sin_vueltas: '',
			lo_central: '',
			en_profundidad: ''
		};

		console.log('Reading levels available:', {
			sin_vueltas: contentData.sin_vueltas ? contentData.sin_vueltas.substring(0, 50) + '...' : 'EMPTY',
			lo_central: contentData.lo_central ? contentData.lo_central.substring(0, 50) + '...' : 'EMPTY',
			en_profundidad: contentData.en_profundidad ? contentData.en_profundidad.substring(0, 50) + '...' : 'EMPTY'
		});

		// Get preferred reading level from localStorage or default to 'lo_central'
		const savedLevel = localStorage.getItem('preferred_reading_level') || 'lo_central';

		// Function to render content for a specific level
		function renderContent(level) {
			console.log('Rendering level:', level);
			let content = contentData[level];

			if (!content || content.trim() === '') {
				console.warn('No content for level:', level, '- using fallback');
				content = contentData.en_profundidad || contentData.lo_central || contentData.sin_vueltas;
			}

			console.log('Content to render (first 100 chars):', content.substring(0, 100));

			// Split by newlines and create paragraphs
			const paragraphs = content.split('\n')
				.filter(p => p.trim())
				.map(p => `<p>${p}</p>`)
				.join('');

			contentDiv.innerHTML = paragraphs;
			console.log('Rendered', paragraphs.split('</p>').length - 1, 'paragraphs');
		}

		// Function to update active button
		function updateActiveButton(level) {
			levelButtons.forEach(btn => {
				if (btn.getAttribute('data-level') === level) {
					btn.classList.add('active');
				} else {
					btn.classList.remove('active');
				}
			});
		}

		// Initialize with saved level if available
		if (savedLevel && document.querySelector(`[data-level="${savedLevel}"]`)) {
			console.log('Initializing with saved level:', savedLevel);
			renderContent(savedLevel);
			updateActiveButton(savedLevel);
		}

		// Add click handlers
		levelButtons.forEach(btn => {
			btn.addEventListener('click', () => {
				const level = btn.getAttribute('data-level');
				console.log('Button clicked, level:', level);
				if (level) {
					renderContent(level);
					updateActiveButton(level);
					// Save preference to localStorage
					localStorage.setItem('preferred_reading_level', level);
				}
			});
		});
	}

	const votesDiv = document.querySelector('.votes');

	if (votesDiv) {
		const id = votesDiv.getAttribute('data-id');
		const countsEl = votesDiv.querySelector('.vote-counts');
		const hotBtn = votesDiv.querySelector('button.vote-btn.hot');
		const coldBtn = votesDiv.querySelector('button.vote-btn.cold');

		// Load initial counts and user vote from localStorage
		const storageKey = `vote_${id}`;
		let userVote = localStorage.getItem(storageKey);

		// Function to update button states
		function updateButtonStates(currentVote) {
			hotBtn?.classList.remove('active');
			coldBtn?.classList.remove('active');

			if (currentVote === 'hot') {
				hotBtn?.classList.add('active');
			} else if (currentVote === 'cold') {
				coldBtn?.classList.add('active');
			}
		}

		// Function to fetch and display vote counts
		async function fetchVoteCounts() {
			try {
				const r = await fetch(`${API_BASE}/api/stats/votes/${id}`);
				if (r.ok) {
					const data = await r.json();
					if (countsEl) {
						countsEl.textContent = `üî• ${data.hot} ¬∑ ‚ùÑÔ∏è ${data.cold}`;
					}
				}
			} catch (e) {
				console.error('Error fetching vote counts:', e);
			}
		}

		// Initialize
		updateButtonStates(userVote);
		fetchVoteCounts();

		// Add click handlers
		votesDiv.querySelectorAll('button.vote-btn').forEach((btn) => {
			btn.addEventListener('click', async () => {
				const voteType = btn.getAttribute('data-type');
				if (!voteType || !id) return;

				// Disable buttons while voting
				hotBtn?.setAttribute('disabled', 'true');
				coldBtn?.setAttribute('disabled', 'true');

				try {
					const r = await fetch(`${API_BASE}/api/publications/${id}/vote`, {
						method: 'POST',
						headers: { 'content-type': 'application/json' },
						body: JSON.stringify({ vote_type: voteType }),
					});

					if (!r.ok) throw new Error(String(r.status));

					const data = await r.json();

					// Update counts
					if (countsEl) {
						countsEl.textContent = `üî• ${data.hot} ¬∑ ‚ùÑÔ∏è ${data.cold}`;
					}

					// Save vote to localStorage
					localStorage.setItem(storageKey, voteType);
					userVote = voteType;

					// Update button states
					updateButtonStates(userVote);

				} catch (e) {
					console.error('Error voting:', e);
					if (countsEl) {
						countsEl.textContent = 'Error al votar';
					}
				} finally {
					// Re-enable buttons
					hotBtn?.removeAttribute('disabled');
					coldBtn?.removeAttribute('disabled');
				}
			});
		});
	}
</script>

<style>
	.breadcrumb { display: flex; align-items: center; gap: 8px; margin-bottom: 24px; font-size: 0.9rem; }
	.breadcrumb a { color: var(--text-secondary); }
	.breadcrumb a:hover { color: var(--accent-secondary); }
	.breadcrumb .sep { color: var(--text-muted); }
	.breadcrumb span:last-child { color: var(--text-muted); }

	.error-card { padding: 48px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); text-align: center; }
	.error-card p { margin: 0 0 16px; color: var(--text-secondary); }
	.back-btn { display: inline-block; padding: 10px 20px; background: var(--accent-primary); color: white; border-radius: var(--radius-md); font-weight: 500; }
	.back-btn:hover { background: var(--accent-secondary); color: white; }

	.article { max-width: 800px; }

	.article-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
	.category { padding: 6px 14px; background: rgba(59, 130, 246, 0.15); border-radius: var(--radius-sm); font-size: 0.85rem; color: var(--accent-secondary); font-weight: 500; }
	.date { font-size: 0.9rem; color: var(--text-muted); }

	.title { margin: 0 0 20px; font-size: 2.5rem; font-weight: 800; letter-spacing: -0.5px; line-height: 1.2; }

	.agent-byline {
		display: flex;
		align-items: center;
		gap: 16px;
		margin: 0 0 24px;
		padding: 16px;
		background: var(--bg-card);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-md);
	}
	.agent-avatar {
		flex-shrink: 0;
		width: 56px;
		height: 56px;
		border-radius: 50%;
		overflow: hidden;
		background: var(--bg-secondary);
		border: 2px solid var(--border-subtle);
	}
	.agent-avatar img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}
	.agent-avatar-placeholder {
		width: 100%;
		height: 100%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.5rem;
		font-weight: 700;
		color: var(--accent-primary);
		background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
	}
	.agent-info {
		flex: 1;
		display: flex;
		flex-direction: column;
		gap: 2px;
	}
	.agent-label {
		font-size: 0.75rem;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		color: var(--text-muted);
		font-weight: 600;
	}
	.agent-name {
		font-size: 1.1rem;
		font-weight: 700;
		color: var(--text-primary);
	}
	.agent-specialization {
		font-size: 0.9rem;
		color: var(--accent-secondary);
		font-weight: 500;
	}

	.summary { margin: 0 0 24px; font-size: 1.2rem; color: var(--text-secondary); line-height: 1.6; padding: 20px; background: var(--bg-card); border-left: 4px solid var(--accent-primary); border-radius: 0 var(--radius-md) var(--radius-md) 0; }

	.tags { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 32px; }
	.tag { padding: 6px 14px; background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); font-size: 0.85rem; color: var(--text-secondary); }

	/* Media Gallery */
	.media-gallery {
		margin: 32px 0;
		display: flex;
		flex-direction: column;
		gap: 24px;
	}
	.media-item {
		width: 100%;
		border-radius: var(--radius-lg);
		overflow: hidden;
		background: var(--bg-card);
		border: 1px solid var(--border-subtle);
	}
	.media-item img {
		width: 100%;
		height: auto;
		display: block;
		max-height: 600px;
		object-fit: cover;
	}
	.video-wrapper {
		position: relative;
		padding-bottom: 56.25%; /* 16:9 aspect ratio */
		height: 0;
		overflow: hidden;
	}
	.video-wrapper iframe {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
	}
	.media-caption {
		padding: 12px 16px;
		font-size: 0.9rem;
		color: var(--text-muted);
		font-style: italic;
		background: var(--bg-secondary);
		border-top: 1px solid var(--border-subtle);
	}

	/* Reading Level Selector */
	.reading-level-selector {
		margin-bottom: 32px;
		padding: 20px;
		background: var(--bg-card);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-md);
	}

	.level-label {
		font-size: 0.85rem;
		font-weight: 600;
		color: var(--text-muted);
		text-transform: uppercase;
		letter-spacing: 0.5px;
		margin-bottom: 12px;
	}

	.level-buttons {
		display: flex;
		gap: 12px;
		flex-wrap: wrap;
	}

	.level-btn {
		display: flex;
		flex-direction: column;
		align-items: flex-start;
		padding: 12px 16px;
		background: var(--bg-secondary);
		border: 2px solid var(--border-subtle);
		border-radius: var(--radius-md);
		cursor: pointer;
		transition: all 0.2s;
		min-width: 140px;
	}

	.level-btn:hover {
		border-color: var(--accent-primary);
		background: var(--bg-card-hover);
		transform: translateY(-2px);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}

	.level-btn.active {
		border-color: var(--accent-primary);
		background: rgba(59, 130, 246, 0.1);
	}

	.level-name {
		font-size: 0.95rem;
		font-weight: 700;
		color: var(--text-primary);
		margin-bottom: 2px;
	}

	.level-desc {
		font-size: 0.75rem;
		color: var(--text-muted);
	}

	.level-btn.active .level-name {
		color: var(--accent-primary);
	}

	.level-btn.active .level-desc {
		color: var(--accent-secondary);
	}

	.body-content { margin-bottom: 40px; }
	.body-content p { margin: 0 0 16px; line-height: 1.8; color: var(--text-primary); font-size: 1.05rem; }

	.article-footer { padding-top: 32px; border-top: 1px solid var(--border-subtle); display: flex; flex-direction: column; gap: 24px; }

	.votes { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
	.votes-label { color: var(--text-secondary); font-size: 0.95rem; }
	.vote-btn {
		padding: 10px 20px;
		background: var(--bg-card);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-md);
		color: var(--text-secondary);
		cursor: pointer;
		font-size: 0.9rem;
		font-weight: 500;
		transition: all 0.2s;
		position: relative;
	}
	.vote-btn:hover:not(:disabled) {
		background: var(--bg-card-hover);
		transform: translateY(-1px);
	}
	.vote-btn:disabled {
		opacity: 0.6;
		cursor: not-allowed;
	}
	.vote-btn.hot:hover:not(:disabled) {
		border-color: #f59e0b;
		color: #f59e0b;
	}
	.vote-btn.hot.active {
		background: rgba(245, 158, 11, 0.15);
		border-color: #f59e0b;
		color: #f59e0b;
		font-weight: 600;
	}
	.vote-btn.cold:hover:not(:disabled) {
		border-color: #3b82f6;
		color: #3b82f6;
	}
	.vote-btn.cold.active {
		background: rgba(59, 130, 246, 0.15);
		border-color: #3b82f6;
		color: #3b82f6;
		font-weight: 600;
	}
	.vote-counts {
		color: var(--text-muted);
		font-size: 0.9rem;
		font-weight: 500;
	}

	.back-link { color: var(--accent-secondary); font-weight: 500; }

	@media (max-width: 768px) {
		.breadcrumb { margin-bottom: 16px; font-size: 0.85rem; }

		.article-header {
			flex-direction: column;
			align-items: flex-start;
			gap: 8px;
			margin-bottom: 12px;
		}

		.title {
			font-size: 1.6rem;
			margin-bottom: 16px;
		}

		.agent-byline {
			padding: 12px;
			gap: 12px;
		}

		.agent-avatar {
			width: 48px;
			height: 48px;
		}

		.agent-name { font-size: 1rem; }

		.summary {
			font-size: 1rem;
			padding: 14px;
			margin-bottom: 20px;
		}

		.tags {
			gap: 6px;
			margin-bottom: 24px;
		}

		.tag {
			padding: 5px 10px;
			font-size: 0.8rem;
		}

		/* Reading level buttons en stack vertical en m√≥vil */
		.reading-level-selector {
			padding: 16px;
			margin-bottom: 24px;
		}

		.level-buttons {
			flex-direction: column;
			gap: 8px;
		}

		.level-btn {
			min-width: 100%;
			padding: 14px 16px;
			flex-direction: row;
			align-items: center;
			justify-content: space-between;
		}

		.level-name { font-size: 0.9rem; }
		.level-desc { font-size: 0.75rem; }

		.body-content p {
			font-size: 1rem;
			line-height: 1.7;
		}

		.article-footer {
			padding-top: 24px;
			gap: 20px;
		}

		.votes {
			flex-direction: column;
			align-items: flex-start;
			gap: 10px;
		}

		.votes-label { font-size: 0.9rem; }

		.vote-btn {
			padding: 12px 24px;
			font-size: 0.95rem;
		}

		.media-item img {
			max-height: 400px;
		}
	}

	@media (max-width: 480px) {
		.title { font-size: 1.4rem; }

		.category {
			padding: 4px 10px;
			font-size: 0.75rem;
		}

		.date { font-size: 0.8rem; }

		.summary {
			font-size: 0.95rem;
			padding: 12px;
			border-left-width: 3px;
		}

		.agent-byline {
			flex-direction: column;
			align-items: flex-start;
			text-align: left;
		}

		.body-content p {
			font-size: 0.95rem;
			margin-bottom: 14px;
		}

		.vote-btn {
			padding: 10px 18px;
			width: 100%;
			justify-content: center;
		}

		.media-item img {
			max-height: 300px;
		}
	}
</style>
