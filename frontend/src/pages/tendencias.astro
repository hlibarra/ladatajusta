---
import Layout from '../layouts/Layout.astro';

type Publication = {
	id: string;
	state: string;
	title: string;
	summary: string;
	body: string;
	category?: string | null;
	tags: string[];
	created_at: string;
	published_at?: string | null;
};

const API_BASE = import.meta.env.PUBLIC_API_BASE_URL ?? 'http://localhost:8000';
let pubs: Publication[] = [];
let error = false;

try {
	const res = await fetch(`${API_BASE}/api/publications`);
	if (res.ok) {
		pubs = await res.json();
	} else {
		error = true;
	}
} catch (e) {
	error = true;
}

// Agrupar por categoría
const categories = pubs.reduce((acc, p) => {
	const cat = p.category || 'Sin categoría';
	if (!acc[cat]) acc[cat] = [];
	acc[cat].push(p);
	return acc;
}, {} as Record<string, Publication[]>);

const categoryList = Object.entries(categories);
---

<Layout title="Tendencias - La Data Justa">
	<section class="page-header">
		<h1 class="page-title">Tendencias</h1>
		<p class="page-subtitle">Noticias organizadas por categoría y relevancia</p>
	</section>

	{error ? (
		<div class="error-card">
			<p>No se pudo conectar con el servidor.</p>
		</div>
	) : pubs.length === 0 ? (
		<div class="empty-card">
			<p>Todavía no hay publicaciones.</p>
			<a href="/" class="back-link">Volver al inicio</a>
		</div>
	) : (
		<div class="categories">
			{categoryList.map(([category, items]) => (
				<section class="category-section">
					<div class="category-header">
						<h2 class="category-title">{category}</h2>
						<span class="category-count">{items.length} noticias</span>
					</div>
					<div class="category-grid">
						{items.slice(0, 4).map((p) => (
							<article class="trend-card">
								<a class="trend-title" href={`/p/${p.id}`}>{p.title}</a>
								<p class="trend-summary">{p.summary}</p>
								<div class="trend-tags">
									{(p.tags ?? []).slice(0, 2).map((t) => (
										<span class="tag">{t}</span>
									))}
								</div>
							</article>
						))}
					</div>
				</section>
			))}
		</div>
	)}
</Layout>

<style>
	.page-header {
		margin-bottom: 40px;
		padding-bottom: 24px;
		border-bottom: 1px solid var(--border-subtle);
	}

	.page-title {
		margin: 0 0 8px;
		font-size: 2.5rem;
		font-weight: 800;
	}

	.page-subtitle {
		margin: 0;
		color: var(--text-secondary);
		font-size: 1.1rem;
	}

	.error-card, .empty-card {
		padding: 48px;
		background: var(--bg-card);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-lg);
		text-align: center;
	}

	.error-card p, .empty-card p {
		margin: 0 0 16px;
		color: var(--text-secondary);
	}

	.back-link {
		color: var(--accent-secondary);
	}

	.categories {
		display: flex;
		flex-direction: column;
		gap: 48px;
	}

	.category-section {
		padding-bottom: 32px;
		border-bottom: 1px solid var(--border-subtle);
	}

	.category-section:last-child {
		border-bottom: none;
	}

	.category-header {
		display: flex;
		align-items: center;
		gap: 12px;
		margin-bottom: 20px;
	}

	.category-title {
		margin: 0;
		font-size: 1.5rem;
		font-weight: 700;
		color: var(--accent-secondary);
	}

	.category-count {
		padding: 4px 10px;
		background: var(--bg-card);
		border-radius: var(--radius-sm);
		font-size: 0.8rem;
		color: var(--text-muted);
	}

	.category-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
		gap: 16px;
	}

	.trend-card {
		padding: 20px;
		background: var(--bg-card);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-lg);
		transition: all 0.2s ease;
	}

	.trend-card:hover {
		background: var(--bg-card-hover);
		border-color: var(--border-medium);
		transform: translateY(-2px);
	}

	.trend-title {
		display: block;
		font-size: 1.1rem;
		font-weight: 600;
		color: var(--text-primary);
		margin-bottom: 8px;
		line-height: 1.4;
	}

	.trend-title:hover {
		color: var(--accent-secondary);
	}

	.trend-summary {
		margin: 0 0 12px;
		color: var(--text-secondary);
		font-size: 0.9rem;
		line-height: 1.5;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.trend-tags {
		display: flex;
		gap: 6px;
	}

	.tag {
		padding: 3px 8px;
		background: var(--bg-secondary);
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-sm);
		font-size: 0.75rem;
		color: var(--text-muted);
	}

	@media (max-width: 768px) {
		.page-header {
			margin-bottom: 28px;
			padding-bottom: 20px;
		}

		.page-title {
			font-size: 1.75rem;
		}

		.page-subtitle {
			font-size: 1rem;
		}

		.categories {
			gap: 32px;
		}

		.category-section {
			padding-bottom: 24px;
		}

		.category-header {
			flex-wrap: wrap;
			gap: 8px;
		}

		.category-title {
			font-size: 1.25rem;
		}

		.category-grid {
			grid-template-columns: 1fr;
			gap: 12px;
		}

		.trend-card {
			padding: 16px;
		}

		.trend-title {
			font-size: 1rem;
		}

		.trend-summary {
			font-size: 0.85rem;
		}
	}

	@media (max-width: 480px) {
		.page-title {
			font-size: 1.5rem;
		}

		.page-subtitle {
			font-size: 0.9rem;
		}

		.category-title {
			font-size: 1.1rem;
		}

		.category-count {
			font-size: 0.75rem;
		}

		.trend-card {
			padding: 14px;
		}

		.tag {
			font-size: 0.7rem;
			padding: 2px 6px;
		}
	}
</style>
